server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: systemd-journal
    static_configs:
      - targets:
          - localhost
        labels:
          job: systemd-journal
          host: fedora-htpc
          __path__: /var/log/journal-export/journal.log
    pipeline_stages:
      - json:
          expressions:
            message: MESSAGE
            priority: PRIORITY
            unit: _SYSTEMD_UNIT
            hostname: _HOSTNAME
            syslog_id: SYSLOG_IDENTIFIER
      - labels:
          priority:
          unit:
          hostname:
          syslog_id:

      # ======================================================================
      # METRIC EXTRACTION: Convert log patterns to Prometheus metrics
      # ======================================================================

      # METRIC 1: Service errors - DISABLED (fundamentally flawed)
      # Problem: Generic priority <=3 matching catches everything (INFO logs at priority 3)
      # Result: False positives (Loki INFO operations triggered ServiceErrorRateHigh)
      # Solution: Use service-specific alerts instead (SLO, Traefik, cAdvisor)
      # Removed: 2026-01-17 (Phase 3 - Eliminate Fragile Log-Based Metrics)
      #
      # - match:
      #     selector: '{priority=~"[0-3]"}'
      #     stages:
      #       - metrics:
      #           service_errors_total:
      #             type: Counter
      #             description: "Total service errors from systemd journal (priority <=3)"
      #             source: priority
      #             config:
      #               action: inc

      # METRIC 2: Immich thumbnail failures
      - match:
          selector: '{syslog_id="immich-server"}'
          pipeline_name: "immich_metrics"
          stages:
            - regex:
                expression: '.*AssetGenerateThumbnails.*ERROR.*'
            - metrics:
                immich_thumbnail_failures_total:
                  type: Counter
                  description: "Immich thumbnail generation failures"
                  config:
                    match_all: true
                    action: inc

      # METRIC 3: Nextcloud cron success counter (NOT a traditional counter - just tracks successes)
      # Philosophy: Alert on "absence of success" not "presence of failure"
      # Counter increments on each success. Use changes() to detect staleness.
      - match:
          selector: '{syslog_id="systemd"}'
          pipeline_name: "nextcloud_cron_success"
          stages:
            - regex:
                expression: '.*Finished nextcloud-cron\.service.*'
            - metrics:
                nextcloud_cron_success_total:
                  type: Counter
                  description: "Increments on each successful cron completion (use changes() for staleness detection)"
                  config:
                    match_all: true
                    action: inc

      # METRIC 4: Jellyfin transcoding failures - DISABLED (no activity)
      # Problem: No transcoding activity in 24+ hours, metric not useful
      # Result: Log-based counter accumulated historical data causing false positives
      # Alternative: Monitor Jellyfin via Traefik 5xx errors if needed
      # Removed: 2026-01-17 (Phase 3 - Eliminate Fragile Log-Based Metrics)
      #
      # - match:
      #     selector: '{syslog_id="jellyfin"}'
      #     pipeline_name: "jellyfin_metrics"
      #     stages:
      #       - regex:
      #           expression: '.*Transcoding.*ERROR.*'
      #       - metrics:
      #           jellyfin_transcoding_failures_total:
      #             type: Counter
      #             description: "Jellyfin transcoding failures"
      #             config:
      #               match_all: true
      #               action: inc

      # METRIC 5: Authelia auth failures - DISABLED (replaced by native metrics)
      # Problem: Log-based counter affected by log rotation, caused false positives
      # Solution: Use Traefik HTTP status codes (401/403) for auth failure detection
      # See: AutheliaAuthFailureSpike alert uses traefik_service_requests_total
      # Benefit: Native metrics, not affected by rotation, more reliable
      # Removed: 2026-01-17 (Phase 3 - Eliminate Fragile Log-Based Metrics)
      #
      # - match:
      #     selector: '{syslog_id="authelia"}'
      #     pipeline_name: "authelia_metrics"
      #     stages:
      #       - regex:
      #           expression: '.*Authentication.*(failed|denied|invalid).*'
      #       - metrics:
      #           authelia_auth_failures_total:
      #             type: Counter
      #             description: "Authelia authentication failures"
      #             config:
      #               match_all: true
      #               action: inc

      # METRIC 6: Container restarts - DISABLED (fundamentally flawed)
      # Problem: Matches normal "container exec_died" events (cron executions)
      # Solution: Use cAdvisor container health metrics instead
      # See: Prometheus alert ContainerUnhealthy for proper health-based detection

      # Final output stage
      - output:
          source: message

  # Remediation decision log (JSONL format)
  - job_name: remediation-decisions
    static_configs:
      - targets:
          - localhost
        labels:
          job: remediation-decisions
          host: fedora-htpc
          __path__: /var/log/remediation/decision-log.jsonl
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            alert: alert
            playbook: playbook
            success: success
            confidence: confidence
            parameters: parameters
            stdout_preview: stdout
            stderr_preview: stderr
      - timestamp:
          source: timestamp
          format: Unix
      - labels:
          alert:
          playbook:
          success:
      - output:
          source: stdout_preview

  # Traefik access logs (errors only)
  - job_name: traefik-access
    static_configs:
      - targets:
          - localhost
        labels:
          job: traefik-access
          host: fedora-htpc
          __path__: /var/log/traefik/access.log
    pipeline_stages:
      - json:
          expressions:
            timestamp: StartUTC
            method: RequestMethod
            path: RequestPath
            status: DownstreamStatus
            duration: Duration
            service: ServiceName
            client_addr: ClientAddr
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - labels:
          method:
          status:
          service:
      - output:
          source: path
