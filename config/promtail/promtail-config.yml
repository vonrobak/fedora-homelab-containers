server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: systemd-journal
    static_configs:
      - targets:
          - localhost
        labels:
          job: systemd-journal
          host: fedora-htpc
          __path__: /var/log/journal-export/journal.log
    pipeline_stages:
      - json:
          expressions:
            message: MESSAGE
            priority: PRIORITY
            unit: _SYSTEMD_UNIT
            hostname: _HOSTNAME
            syslog_id: SYSLOG_IDENTIFIER
      - labels:
          priority:
          unit:
          hostname:
          syslog_id:

      # ======================================================================
      # METRIC EXTRACTION: Convert log patterns to Prometheus metrics
      # ======================================================================

      # METRIC 1: Service errors (priority <=3)
      - match:
          selector: '{priority=~"[0-3]"}'
          stages:
            - metrics:
                service_errors_total:
                  type: Counter
                  description: "Total service errors from systemd journal (priority <=3)"
                  source: priority
                  config:
                    action: inc

      # METRIC 2: Immich thumbnail failures
      - match:
          selector: '{syslog_id="immich-server"}'
          pipeline_name: "immich_metrics"
          stages:
            - regex:
                expression: '.*AssetGenerateThumbnails.*ERROR.*'
            - metrics:
                immich_thumbnail_failures_total:
                  type: Counter
                  description: "Immich thumbnail generation failures"
                  config:
                    match_all: true
                    action: inc

      # METRIC 3: Nextcloud cron failures
      - match:
          selector: '{syslog_id=~"nextcloud.*"}'
          pipeline_name: "nextcloud_metrics"
          stages:
            - regex:
                expression: '.*(failed|error|ERROR|not found).*'
            - metrics:
                nextcloud_cron_failures_total:
                  type: Counter
                  description: "Nextcloud cron/background job failures"
                  config:
                    match_all: true
                    action: inc

      # METRIC 4: Jellyfin transcoding failures
      - match:
          selector: '{syslog_id="jellyfin"}'
          pipeline_name: "jellyfin_metrics"
          stages:
            - regex:
                expression: '.*Transcoding.*ERROR.*'
            - metrics:
                jellyfin_transcoding_failures_total:
                  type: Counter
                  description: "Jellyfin transcoding failures"
                  config:
                    match_all: true
                    action: inc

      # METRIC 5: Authelia auth failures
      - match:
          selector: '{syslog_id="authelia"}'
          pipeline_name: "authelia_metrics"
          stages:
            - regex:
                expression: '.*Authentication.*(failed|denied|invalid).*'
            - metrics:
                authelia_auth_failures_total:
                  type: Counter
                  description: "Authelia authentication failures"
                  config:
                    match_all: true
                    action: inc

      # METRIC 6: Container restarts (simplified - excludes exec completions manually)
      - match:
          selector: '{syslog_id="podman"}'
          pipeline_name: "container_metrics"
          stages:
            - regex:
                expression: '.*(container died|container killed|Exited with error).*'
            - metrics:
                container_unplanned_restarts_total:
                  type: Counter
                  description: "Unplanned container restarts (died/killed/error exits)"
                  config:
                    match_all: true
                    action: inc

      # Final output stage
      - output:
          source: message

  # Remediation decision log (JSONL format)
  - job_name: remediation-decisions
    static_configs:
      - targets:
          - localhost
        labels:
          job: remediation-decisions
          host: fedora-htpc
          __path__: /var/log/remediation/decision-log.jsonl
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            alert: alert
            playbook: playbook
            success: success
            confidence: confidence
            parameters: parameters
            stdout_preview: stdout
            stderr_preview: stderr
      - timestamp:
          source: timestamp
          format: Unix
      - labels:
          alert:
          playbook:
          success:
      - output:
          source: stdout_preview

  # Traefik access logs (errors only)
  - job_name: traefik-access
    static_configs:
      - targets:
          - localhost
        labels:
          job: traefik-access
          host: fedora-htpc
          __path__: /var/log/traefik/access.log
    pipeline_stages:
      - json:
          expressions:
            timestamp: StartUTC
            method: RequestMethod
            path: RequestPath
            status: DownstreamStatus
            duration: Duration
            service: ServiceName
            client_addr: ClientAddr
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - labels:
          method:
          status:
          service:
      - output:
          source: path
