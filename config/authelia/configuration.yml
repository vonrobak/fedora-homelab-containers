---
###############################################################
#                   Authelia Configuration                   #
#           YubiKey-First SSO Authentication                 #
###############################################################

theme: dark
default_2fa_method: webauthn

server:
  address: 'tcp://0.0.0.0:9091'
  buffers:
    read: 4096
    write: 4096
  timeouts:
    read: 30s
    write: 30s
    idle: 120s

log:
  level: debug
  format: text

# JWT secret for tokens (from Podman secret)
# Set via environment variable: AUTHELIA_JWT_SECRET

totp:
  disable: false
  issuer: patriark.org
  algorithm: sha1
  digits: 6
  period: 30
  skew: 1

webauthn:
  disable: false
  timeout: 60s
  display_name: Patriark Homelab
  attestation_conveyance_preference: indirect
  user_verification: preferred

authentication_backend:
  password_reset:
    disable: true
  refresh_interval: 5m

  file:
    path: /config/users_database.yml
    watch: true
    password:
      algorithm: argon2
      argon2:
        variant: argon2id
        iterations: 3
        memory: 65536
        parallelism: 4
        key_length: 32
        salt_length: 16

access_control:
  default_policy: deny

  rules:
    # Health check endpoints - bypass auth
    - domain: '*.patriark.org'
      policy: bypass
      resources:
        - '^/api/health$'
        - '^/health$'
        - '^/ping$'

    # Tier 1: Admin Services - YubiKey Required (two_factor)
    - domain:
        - 'grafana.patriark.org'
        - 'prometheus.patriark.org'
        - 'traefik.patriark.org'
        - 'loki.patriark.org'
        - 'home.patriark.org'
        - 'patriark.org'
      policy: two_factor
      subject:
        - 'group:admins'

    # Tier 2: Media Services - Web UI requires auth, APIs bypass
    # Jellyfin - Bypass API endpoints for mobile apps
    - domain: 'jellyfin.patriark.org'
      policy: bypass
      resources:
        - '^/api/.*'
        - '^/System/.*'
        - '^/Sessions/.*'
        - '^/Users/.*/Authenticate'

    # Jellyfin - Web UI requires two-factor
    - domain: 'jellyfin.patriark.org'
      policy: two_factor
      subject:
        - 'group:users'

    # Gathio Event Management - Path-based protection
    # Protect event CREATION (admin only)
    - domain: 'events.patriark.org'
      policy: two_factor
      subject:
        - 'group:users'
      resources:
        - '^/new.*'         # Event creation page
        - '^/event$'        # Event creation POST endpoint (exact match)
        - '^/group$'        # Group creation POST endpoint
        - '^/edit/.*'       # Event editing (backup - also password protected)

    # Public access for event VIEWING and RSVP (shareable links)
    - domain: 'events.patriark.org'
      policy: bypass
      resources:
        - '^/$'             # Homepage (if you want public event list)
        - '^/[A-Za-z0-9_-]{10,30}.*$'  # Event/group pages by ID (e.g., /TvdMqJQ4jZfJXsUSyZgUf)
        - '^/attendee/.*'   # Attendee management (RSVP, add/remove attendees)
        - '^/comment/.*'    # Comments on events
        - '^/api/.*'        # Public API endpoints
        - '^/css/.*'        # CSS files (required for page rendering)
        - '^/js/.*'         # JavaScript files (required for buttons)
        - '^/fonts/.*'      # Web fonts
        - '^/images/.*'     # Static images
        - '^/.*\.(ico|png|jpg|svg|webmanifest|xml)$'  # Favicon and icons

    # Immich - Not protected by Authelia (uses native authentication)
    # Removed from Authelia to allow consistent mobile + web experience

session:
  secret: file:///run/secrets/authelia_session_secret
  name: authelia_session
  same_site: lax
  expiration: 1h
  inactivity: 15m
  remember_me: 1M

  cookies:
    - domain: patriark.org
      authelia_url: https://sso.patriark.org
      default_redirection_url: https://grafana.patriark.org

  redis:
    host: redis-authelia
    port: 6379
    database_index: 0
    maximum_active_connections: 8
    minimum_idle_connections: 0

regulation:
  max_retries: 5
  find_time: 2m
  ban_time: 5m

storage:
  encryption_key: file:///run/secrets/authelia_storage_key

  local:
    path: /data/db.sqlite3

notifier:
  disable_startup_check: false

  filesystem:
    filename: /data/notification.txt

identity_validation:
  reset_password:
    jwt_secret: file:///run/secrets/authelia_jwt_secret
