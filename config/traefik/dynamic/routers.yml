http:
  routers:
    # Root domain â†’ Homepage Dashboard
    root-redirect:
      rule: "Host(`patriark.org`)"
      service: "homepage"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Homepage Dashboard (explicit subdomain)
    homepage-dashboard:
      rule: "Host(`home.patriark.org`)"
      service: "homepage"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Authelia SSO Portal (YubiKey-First Authentication)
    authelia-portal:
      rule: "Host(`sso.patriark.org`)"
      service: "authelia"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - circuit-breaker@file         # Prevent cascade failures
        - retry@file                   # Retry transient endpoint errors
      tls:
        certResolver: letsencrypt

    # Vaultwarden Password Manager (NO Authelia - has own authentication)
    vaultwarden-secure:
      rule: "Host(`vault.patriark.org`)"
      service: "vaultwarden"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit-vaultwarden@file
        - security-headers@file
      tls:
        certResolver: letsencrypt

    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`traefik.patriark.org`)"
      service: "api@internal"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Jellyfin - Uses native authentication (no Authelia SSO)
    # Media Player clients and web UI both use Jellyfin's built-in auth
    jellyfin-secure:
      rule: "Host(`jellyfin.patriark.org`)"
      service: "jellyfin"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit-public@file
        - security-headers@file
      tls:
        certResolver: letsencrypt

    # Immich - Uses native authentication (no Authelia SSO)
    # Mobile apps and web UI both use Immich's built-in auth
    immich-secure:
      rule: "Host(`photos.patriark.org`)"
      service: "immich"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit-immich@file       # Custom high-capacity rate limit for photo browsing
        - circuit-breaker@file         # Prevent cascade failures
        - retry@file                   # Retry transient connection errors
        - compression@file
        - security-headers@file
      tls:
        certResolver: letsencrypt

    # Nextcloud - Uses native authentication (no Authelia SSO)
    # CalDAV/CardDAV clients and web UI use Nextcloud's built-in auth
    # NO security-headers middleware (Nextcloud sets own CSP)
    # HSTS-only middleware (Nextcloud sets CSP, we add HSTS)
    nextcloud-secure:
      rule: "Host(`nextcloud.patriark.org`)"
      service: "nextcloud"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit-nextcloud@file     # High capacity for WebDAV sync, bulk imports (400/min, 1400 burst)
        - circuit-breaker@file          # Prevent cascade failures
        - retry@file                    # Retry transient errors
        - nextcloud-caldav              # CalDAV/.well-known redirects
        - hsts-only@file                # Add HSTS without conflicting with Nextcloud's CSP
      tls:
        certResolver: letsencrypt

    # Collabora Online - INTERNAL ONLY (accessed by Nextcloud via http://collabora:9980)
    # Removed public router - Collabora does not need Internet access
    # Nextcloud communicates with it directly on the nextcloud network
    # This reduces attack surface and follows least-privilege principle

    # Grafana Monitoring Dashboard
    grafana-secure:
      rule: "Host(`grafana.patriark.org`)"
      service: "grafana"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Prometheus Metrics Database
    prometheus-secure:
      rule: "Host(`prometheus.patriark.org`)"
      service: "prometheus"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Loki Log Aggregation
    loki-secure:
      rule: "Host(`loki.patriark.org`)"
      service: "loki"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Alertmanager - Alert Routing and Notification
    alertmanager-secure:
      rule: "Host(`alertmanager.patriark.org`)"
      service: "alertmanager"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
        - security-headers-strict@file
      tls:
        certResolver: letsencrypt

  services:
    homepage:
      loadBalancer:
        servers:
          - url: "http://homepage:3000"

    jellyfin:
      loadBalancer:
        servers:
          - url: "http://jellyfin:8096"

    immich:
      loadBalancer:
        servers:
          - url: "http://immich-server:2283"

    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    prometheus:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"

    loki:
      loadBalancer:
        servers:
          - url: "http://loki:3100"

    alertmanager:
      loadBalancer:
        servers:
          - url: "http://alertmanager:9093"

    authelia:
      loadBalancer:
        servers:
          - url: "http://authelia:9091"

    vaultwarden:
      loadBalancer:
        servers:
          - url: "http://vaultwarden:80"

    nextcloud:
      loadBalancer:
        servers:
          - url: "http://nextcloud:80"

    # collabora: (removed - internal-only service, no public router needed)

  middlewares:
    # CalDAV/.well-known redirects for Nextcloud
    nextcloud-caldav:
      redirectRegex:
        permanent: true
        regex: "^https://(.*)/.well-known/(card|cal)dav"
        replacement: "https://${1}/remote.php/dav/"
