http:
  routers:
    # Root domain â†’ Homepage Dashboard
    root-redirect:
      rule: "Host(`patriark.org`)"
      service: "homepage"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Homepage Dashboard (explicit subdomain)
    homepage-dashboard:
      rule: "Host(`home.patriark.org`)"
      service: "homepage"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Authelia SSO Portal (YubiKey-First Authentication)
    authelia-portal:
      rule: "Host(`sso.patriark.org`)"
      service: "authelia"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - circuit-breaker@file         # Prevent cascade failures
        - retry@file                   # Retry transient endpoint errors
      tls:
        certResolver: letsencrypt

    # Vaultwarden Password Manager (NO Authelia - has own authentication)
    vaultwarden-secure:
      rule: "Host(`vault.patriark.org`)"
      service: "vaultwarden"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit-vaultwarden@file
        - security-headers@file
      tls:
        certResolver: letsencrypt

    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`traefik.patriark.org`)"
      service: "api@internal"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Jellyfin - Uses native authentication (no Authelia SSO)
    # Media Player clients and web UI both use Jellyfin's built-in auth
    jellyfin-secure:
      rule: "Host(`jellyfin.patriark.org`)"
      service: "jellyfin"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit-public@file
        - security-headers@file
      tls:
        certResolver: letsencrypt

    # Immich - Uses native authentication (no Authelia SSO)
    # Mobile apps and web UI both use Immich's built-in auth
    immich-secure:
      rule: "Host(`photos.patriark.org`)"
      service: "immich"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit-immich@file       # Custom high-capacity rate limit for photo browsing
        - circuit-breaker@file         # Prevent cascade failures
        - retry@file                   # Retry transient connection errors
        - compression@file
        - security-headers@file
      tls:
        certResolver: letsencrypt

    # Nextcloud - Uses native authentication (no Authelia SSO)
    # CalDAV/CardDAV clients and web UI use Nextcloud's built-in auth
    # NO security-headers middleware (Nextcloud sets own CSP)
    # HSTS-only middleware (Nextcloud sets CSP, we add HSTS)
    nextcloud-secure:
      rule: "Host(`nextcloud.patriark.org`)"
      service: "nextcloud"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit-nextcloud@file     # High capacity for WebDAV sync (600/min, 3000 burst for PROPFIND tree walks)
        - circuit-breaker@file          # Prevent cascade failures
        - retry@file                    # Retry transient errors
        - nextcloud-caldav              # CalDAV/.well-known redirects
        - hsts-only@file                # Add HSTS without conflicting with Nextcloud's CSP
      tls:
        certResolver: letsencrypt

    # Collabora Online - Browser needs direct access to load editor iframe
    # Server-to-server WOPI calls go via internal network (http://collabora:9980)
    # But browser must load cool.html from Collabora directly
    collabora-secure:
      rule: "Host(`collabora.patriark.org`)"
      service: "collabora"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - hsts-only@file                # Collabora sets own CSP/frame-ancestors - just add HSTS
      tls:
        certResolver: letsencrypt

    # Grafana Monitoring Dashboard
    grafana-secure:
      rule: "Host(`grafana.patriark.org`)"
      service: "grafana"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Prometheus Metrics Database
    prometheus-secure:
      rule: "Host(`prometheus.patriark.org`)"
      service: "prometheus"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Loki Log Aggregation
    loki-secure:
      rule: "Host(`loki.patriark.org`)"
      service: "loki"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Alertmanager - INTERNAL ONLY (accessed via http://alertmanager:9093)
    # Removed public router - Alertmanager is only for internal monitoring stack use
    # Access via Grafana dashboards or direct container access
    # This reduces attack surface for operational infrastructure

    # Gathio Event Management Platform
    gathio-secure:
      rule: "Host(`events.patriark.org`)"
      service: "gathio"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        - authelia@file               # Protect event creation interface
        - security-headers-gathio@file  # Relaxed CSP for CDN resources
      tls:
        certResolver: letsencrypt

    # Home Assistant - NO Authelia (has own built-in authentication)
    # Mobile app + Web UI work seamlessly without SSO layer
    home-assistant-secure:
      rule: "Host(`ha.patriark.org`)"
      service: "home-assistant"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit@file
        # NO authelia@file - HA has robust built-in auth
        - security-headers-ha@file
      tls:
        certResolver: letsencrypt

  services:
    homepage:
      loadBalancer:
        servers:
          - url: "http://homepage:3000"

    jellyfin:
      loadBalancer:
        servers:
          - url: "http://jellyfin:8096"

    immich:
      loadBalancer:
        servers:
          - url: "http://immich-server:2283"

    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    prometheus:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"

    loki:
      loadBalancer:
        servers:
          - url: "http://loki:3100"

    # alertmanager: (removed - internal-only service, no public router needed)

    authelia:
      loadBalancer:
        servers:
          - url: "http://authelia:9091"

    vaultwarden:
      loadBalancer:
        servers:
          - url: "http://vaultwarden:80"

    nextcloud:
      loadBalancer:
        servers:
          - url: "http://nextcloud:80"

    collabora:
      loadBalancer:
        servers:
          - url: "http://collabora:9980"

    gathio:
      loadBalancer:
        servers:
          - url: "http://gathio:3000"

    home-assistant:
      loadBalancer:
        servers:
          - url: "http://home-assistant:8123"

  middlewares:
    # CalDAV/.well-known redirects for Nextcloud
    nextcloud-caldav:
      redirectRegex:
        permanent: true
        regex: "^https://(.*)/.well-known/(card|cal)dav"
        replacement: "https://${1}/remote.php/dav/"
