http:
  routers:
    # Root domain â†’ Homepage Dashboard
    root-redirect:
      rule: "Host(`patriark.org`)"
      service: "homepage"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Homepage Dashboard (explicit subdomain)
    homepage-dashboard:
      rule: "Host(`home.patriark.org`)"
      service: "homepage"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Tinyauth portal
    tinyauth-portal:
      rule: "Host(`auth.patriark.org`)"
      service: "tinyauth"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
      tls:
        certResolver: letsencrypt

    # Authelia SSO Portal (YubiKey-First Authentication)
    authelia-portal:
      rule: "Host(`sso.patriark.org`)"
      service: "authelia"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
      tls:
        certResolver: letsencrypt

    # Vaultwarden Password Manager (NO Authelia - has own authentication)
    vaultwarden-secure:
      rule: "Host(`vault.patriark.org`)"
      service: "vaultwarden"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file
        - rate-limit-vaultwarden@file
        - security-headers@file
      tls:
        certResolver: letsencrypt

    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`traefik.patriark.org`)"
      service: "api@internal"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Jellyfin
    jellyfin-secure:
      rule: "Host(`jellyfin.patriark.org`)"
      service: "jellyfin"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit-public
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Immich - Uses native authentication (no Authelia SSO)
    # Mobile apps and web UI both use Immich's built-in auth
    immich-secure:
      rule: "Host(`photos.patriark.org`)"
      service: "immich"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit-public
      tls:
        certResolver: letsencrypt

    # Grafana Monitoring Dashboard
    grafana-secure:
      rule: "Host(`grafana.patriark.org`)"
      service: "grafana"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Prometheus Metrics Database
    prometheus-secure:
      rule: "Host(`prometheus.patriark.org`)"
      service: "prometheus"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
        - authelia@file
      tls:
        certResolver: letsencrypt

    # Loki Log Aggregation
    loki-secure:
      rule: "Host(`loki.patriark.org`)"
      service: "loki"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
        - authelia@file
      tls:
        certResolver: letsencrypt

  services:
    homepage:
      loadBalancer:
        servers:
          - url: "http://homepage:3000"

    jellyfin:
      loadBalancer:
        servers:
          - url: "http://jellyfin:8096"

    tinyauth:
      loadBalancer:
        servers:
          - url: "http://tinyauth:3000"

    immich:
      loadBalancer:
        servers:
          - url: "http://immich-server:2283"

    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    prometheus:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"

    loki:
      loadBalancer:
        servers:
          - url: "http://loki:3100"

    authelia:
      loadBalancer:
        servers:
          - url: "http://authelia:9091"

    vaultwarden:
      loadBalancer:
        servers:
          - url: "http://vaultwarden:80"
