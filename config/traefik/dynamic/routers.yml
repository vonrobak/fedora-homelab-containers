http:
  routers:
    # Root domain redirect
    root-redirect:
      rule: "Host(`patriark.org`)"
      service: "tinyauth"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
      tls:
        certResolver: letsencrypt

    # Tinyauth portal
    tinyauth-portal:
      rule: "Host(`auth.patriark.org`)"
      service: "tinyauth"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
      tls:
        certResolver: letsencrypt

    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`traefik.patriark.org`)"
      service: "api@internal"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
        - tinyauth@file
      tls:
        certResolver: letsencrypt

    # Jellyfin
    jellyfin-secure:
      rule: "Host(`jellyfin.patriark.org`)"
      service: "jellyfin"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit-public
        # - tinyauth@file  # Uncomment to enable authentication
      tls:
        certResolver: letsencrypt

    # Immich - Static Assets (bypass auth for /_app/ JavaScript/CSS)
    immich-assets:
      rule: "Host(`photos.patriark.org`) && PathPrefix(`/_app/`)"
      service: "immich"
      entryPoints:
        - websecure
      priority: 100  # Higher priority = evaluated first
      middlewares:
        - crowdsec-bouncer
        - rate-limit
      tls:
        certResolver: letsencrypt

    # Immich - Main Application (with auth)
    immich-secure:
      rule: "Host(`photos.patriark.org`)"
      service: "immich"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
        - tinyauth@file
      tls:
        certResolver: letsencrypt

    # Grafana Monitoring Dashboard
    grafana-secure:
      rule: "Host(`grafana.patriark.org`)"
      service: "grafana"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - rate-limit
        - tinyauth@file
      tls:
        certResolver: letsencrypt

    # Prometheus Metrics Database
    prometheus-secure:
      rule: "Host(`prometheus.patriark.org`)"
      service: "prometheus"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - monitoring-api-whitelist
        - rate-limit
        - tinyauth@file
      tls:
        certResolver: letsencrypt

    # Loki Log Aggregation
    loki-secure:
      rule: "Host(`loki.patriark.org`)"
      service: "loki"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer
        - monitoring-api-whitelist
        - rate-limit
        - tinyauth@file
      tls:
        certResolver: letsencrypt

  services:
    jellyfin:
      loadBalancer:
        servers:
          - url: "http://jellyfin:8096"

    tinyauth:
      loadBalancer:
        servers:
          - url: "http://tinyauth:3000"

    immich:
      loadBalancer:
        servers:
          - url: "http://immich-server:2283"

    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    prometheus:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"

    loki:
      loadBalancer:
        servers:
          - url: "http://loki:3100"
