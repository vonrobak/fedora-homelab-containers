# OCIS Cloud Platform Routing
# Created: 2025-11-12

http:
  routers:
    # OCIS Cloud - Main Interface
    ocis-secure:
      rule: "Host(`cloud.patriark.org`)"
      service: "ocis"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file      # 1. Block bad IPs (fastest)
        - rate-limit-ocis@file        # 2. Higher capacity for OIDC/JWKS traffic
        - circuit-breaker@file        # 3. Prevent cascade failures from external OIDC
        - retry@file                  # 4. Retry transient OIDC/JWKS failures
      tls:
        certResolver: letsencrypt

  services:
    ocis:
      loadBalancer:
        servers:
          - url: "http://ocis:9200"
        passHostHeader: true
        healthCheck:
          path: "/"
          interval: "30s"
          timeout: "5s"
