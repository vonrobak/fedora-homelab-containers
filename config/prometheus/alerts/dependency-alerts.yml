################################################################################
# Dependency Mapping Alerting Rules
# Phase 2: Service Dependency Mapping & Impact Analysis
#
# These alerts monitor the health and state of service dependencies, detecting
# critical issues that could cascade through the system.
#
# Created: 2025-12-01
# Author: Claude (Service Dependency Mapping System)
################################################################################

groups:
  - name: dependency_health
    interval: 60s
    rules:
      # Alert when a critical service has an unhealthy RUNTIME dependency
      # FIXED 2025-12-06: Use homelab_service label to avoid collision with job="node_exporter"
      # FIXED 2025-12-11: Exclude routing dependencies - they don't affect service functionality
      - alert: CriticalServiceDependencyUnhealthy
        expr: |
          (
            homelab_dependency_health{dependency_type!="routing"} == 0
          )
          and on(homelab_service) (
            homelab_critical_service_status{} == 1
          )
        for: 5m  # Increased from 2m to reduce flapping on transient dependency issues
        labels:
          severity: critical
          component: dependencies
          category: health
        annotations:
          summary: "Critical service {{ $labels.homelab_service }} has unhealthy runtime dependency"
          description: |
            Critical service {{ $labels.homelab_service }} has a runtime dependency on {{ $labels.dependency }} which is currently unhealthy.
            This WILL cause service degradation or failures.

            Affected service: {{ $labels.homelab_service }}
            Unhealthy dependency: {{ $labels.dependency }}
            Dependency type: {{ $labels.dependency_type }}
            Dependency strength: {{ $labels.dependency_strength }}

            Action: Investigate dependency health immediately to prevent service impact.
              systemctl --user status {{ $labels.dependency }}.service
              podman ps --filter name={{ $labels.dependency }}
          runbook_url: "https://github.com/patriark/homelab/docs/20-operations/runbooks/DR-001-dependency-failure.md"

      # Alert when a routing target is unhealthy (informational, not critical)
      # Routing dependencies (e.g., Traefik -> Immich) don't affect the router's functionality
      - alert: RoutingTargetUnhealthy
        expr: |
          homelab_dependency_health{dependency_type="routing"} == 0
        for: 10m  # Increased from 5m - routing targets being briefly down is less critical
        labels:
          severity: info  # Downgraded from warning - router continues functioning for other targets
          component: dependencies
          category: availability
        annotations:
          summary: "Routing target {{ $labels.dependency }} is unhealthy"
          description: |
            Service {{ $labels.homelab_service }} routes traffic to {{ $labels.dependency }} which is currently unhealthy.
            The routing service ({{ $labels.homelab_service }}) continues to function normally for other targets.

            Router: {{ $labels.homelab_service }}
            Unhealthy target: {{ $labels.dependency }}

            Impact: Only {{ $labels.dependency }} is unavailable. Other services are unaffected.

            Action: Investigate target service health:
              systemctl --user status {{ $labels.dependency }}.service
              podman ps --filter name={{ $labels.dependency }}
              podman logs {{ $labels.dependency }} --tail 50

      # Alert when a high blast radius service goes down
      - alert: HighBlastRadiusServiceDown
        expr: |
          (
            homelab_critical_service_status{} == 0
          )
          and on(homelab_service) (
            homelab_service_blast_radius{} > 3
          )
        for: 3m  # Increased from 1m to reduce flapping on transient health check failures
        labels:
          severity: critical
          component: dependencies
          category: availability
        annotations:
          summary: "High blast radius service {{ $labels.homelab_service }} is down"
          description: |
            Service {{ $labels.homelab_service }} is down and has a blast radius of {{ $value }} services.
            This affects multiple dependent services across the system.

            Blast radius: {{ $value }} services
            Service: {{ $labels.homelab_service }}

            Potentially affected services should be checked for cascading failures.

            Action: Restart service immediately and assess impact on dependents.
          runbook_url: "https://github.com/patriark/homelab/docs/20-operations/runbooks/DR-001-dependency-failure.md"

      # Alert when dependency graph becomes stale
      - alert: DependencyGraphStale
        expr: homelab_dependency_graph_staleness_seconds > 90000
        for: 5m
        labels:
          severity: warning
          component: dependencies
          category: maintenance
        annotations:
          summary: "Dependency graph is stale ({{ $value | humanizeDuration }})"
          description: |
            The dependency graph has not been updated in {{ $value | humanizeDuration }}.

            Expected refresh: Daily at 06:00 (24h max staleness)
            Current staleness: {{ $value | humanizeDuration }}

            This may indicate:
            - dependency-discovery.timer is not running
            - discovery script is failing
            - systemd timer configuration issues

            Action: Check dependency-discovery.timer status and logs:
              systemctl --user status dependency-discovery.timer
              journalctl --user -u dependency-discovery.service -n 50
          runbook_url: "https://github.com/patriark/homelab/docs/20-operations/runbooks/DR-001-dependency-failure.md"

      # Alert when a medium blast radius service goes down (warning level)
      - alert: MediumBlastRadiusServiceDown
        expr: |
          (
            homelab_critical_service_status{} == 0
          )
          and on(homelab_service) (
            homelab_service_blast_radius{} > 1 and homelab_service_blast_radius{} <= 3
          )
        for: 5m
        labels:
          severity: warning
          component: dependencies
          category: availability
        annotations:
          summary: "Service {{ $labels.homelab_service }} with {{ $value }} dependents is down"
          description: |
            Service {{ $labels.homelab_service }} is down and has {{ $value }} dependent services.

            Blast radius: {{ $value }} services
            Service: {{ $labels.homelab_service }}

            Monitor dependent services for potential issues.

            Action: Investigate service failure and restart if needed.

  - name: dependency_drift
    interval: 300s
    rules:
      # Alert when dependency drift is detected (Phase 4 feature)
      - alert: DependencyDriftDetected
        expr: homelab_dependency_drift_detected{} == 1
        for: 5m
        labels:
          severity: info
          component: dependencies
          category: configuration
        annotations:
          summary: "Dependency drift detected on {{ $labels.homelab_service }}"
          description: |
            Service {{ $labels.homelab_service }} has configuration drift in its dependencies.

            Drift type: {{ $labels.type }}
            Service: {{ $labels.homelab_service }}

            This means the running configuration differs from the declared state in quadlet files.

            Possible causes:
            - Manual container modifications
            - Network changes not reflected in quadlets
            - Stack file updates not applied

            Action: Review drift report and reconcile configuration:
              ~/containers/.claude/skills/homelab-deployment/scripts/check-drift.sh {{ $labels.homelab_service }}
          runbook_url: "https://github.com/patriark/homelab/docs/20-operations/runbooks/DR-001-dependency-failure.md"

  - name: dependency_capacity
    interval: 60s
    rules:
      # DeepDependencyChain alert REMOVED - architectural metric, not an actionable incident
      # Monitor this via Grafana dashboard instead of alerting
      # Metric available: homelab_dependency_chain_depth{}
