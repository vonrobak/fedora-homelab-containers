# Multi-Window SLO Burn Rate Alerts
# Created: 2025-12-19
# Based on: Google SRE Book - Multi-Window, Multi-Burn-Rate Alerts
#
# Philosophy: Alert at multiple time scales to catch both fast catastrophes
# and slow degradations BEFORE they exhaust the error budget.
#
# Four-Tier Approach:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Tier    â”‚ Windows      â”‚ Budget Left   â”‚ Severity     â”‚ Action      â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Tier 1  â”‚ 1h + 5m      â”‚ 2% (58 min)   â”‚ Critical     â”‚ Page        â”‚
# â”‚ Tier 2  â”‚ 6h + 30m     â”‚ 5% (2.4 hrs)  â”‚ Warning      â”‚ Ticket      â”‚
# â”‚ Tier 3  â”‚ 1d + 2h      â”‚ 10% (3 days)  â”‚ Warning      â”‚ Ticket      â”‚
# â”‚ Tier 4  â”‚ 3d + 6h      â”‚ 20% (7 days)  â”‚ Info         â”‚ Review      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

groups:
  # ===========================================================================
  # JELLYFIN - Multi-Window Burn Rate Alerts
  # ===========================================================================
  - name: slo_multiwindow_jellyfin
    interval: 1m
    rules:
      # TIER 1: CRITICAL - Fast Burn (Page immediately)
      # Budget exhausts in <3 hours at this rate
      - alert: SLOBurnRateTier1_Jellyfin
        expr: |
          (
            burn_rate:jellyfin:availability:1h > 14.4
            and
            burn_rate:jellyfin:availability:5m > 14.4
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 3600)
        for: 2m
        labels:
          severity: critical
          component: slo
          service: jellyfin
          slo: availability
          tier: "1"
          burn_rate: "fast"
        annotations:
          summary: "ğŸš¨ CRITICAL: Jellyfin error budget burning at 14.4x normal rate"
          description: |
            **IMMEDIATE ACTION REQUIRED**

            Jellyfin availability is degrading rapidly. At this burn rate, the monthly error budget
            will be exhausted in less than 3 hours.

            **Current State:**
            - Burn Rate (1h): {{ $value | humanize }}x normal
            - Burn Rate (5m): {{ query "burn_rate:jellyfin:availability:5m" | first | value | humanize }}x normal
            - Error Budget Remaining: {{ query "error_budget:jellyfin:availability:budget_remaining * 100" | first | value | humanize }}%
            - Days Until Exhaustion: {{ query "error_budget:jellyfin:availability:days_remaining" | first | value | humanize }} days

            **Impact:** Users are experiencing service failures RIGHT NOW.

            **Action:** Investigate and resolve immediately. Check:
              systemctl --user status jellyfin.service
              podman logs jellyfin --tail 100
              ~/containers/scripts/homelab-intel.sh

      # TIER 2: WARNING - Medium Burn (Create ticket)
      # Budget exhausts in <1 day at this rate
      - alert: SLOBurnRateTier2_Jellyfin
        expr: |
          (
            burn_rate:jellyfin:availability:6h > 6
            and
            burn_rate:jellyfin:availability:30m > 6
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 21600)
        for: 15m
        labels:
          severity: warning
          component: slo
          service: jellyfin
          slo: availability
          tier: "2"
          burn_rate: "medium"
        annotations:
          summary: "âš ï¸ Jellyfin error budget burning at 6x normal rate"
          description: |
            **Action needed within hours**

            Jellyfin availability is degrading. At this burn rate, the monthly error budget
            will be exhausted in less than 1 day.

            **Current State:**
            - Burn Rate (6h): {{ $value | humanize }}x normal
            - Burn Rate (30m): {{ query "burn_rate:jellyfin:availability:30m" | first | value | humanize }}x normal
            - Error Budget Remaining: {{ query "error_budget:jellyfin:availability:budget_remaining * 100" | first | value | humanize }}%
            - Days Until Exhaustion: {{ query "error_budget:jellyfin:availability:days_remaining" | first | value | humanize }} days

            **Impact:** Increased error rate, degraded user experience.

            **Action:** Investigate and plan remediation. This can wait until business hours
            but should not be ignored.

      # TIER 3: WARNING - Slow Burn (Plan remediation)
      # Budget exhausts in <1 week at this rate
      - alert: SLOBurnRateTier3_Jellyfin
        expr: |
          (
            burn_rate:jellyfin:availability:1d > 3
            and
            burn_rate:jellyfin:availability:2h > 3
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 86400)
        for: 1h
        labels:
          severity: warning
          component: slo
          service: jellyfin
          slo: availability
          tier: "3"
          burn_rate: "slow"
        annotations:
          summary: "ğŸ“Š Jellyfin error budget burning at 3x normal rate"
          description: |
            **Trend to monitor**

            Jellyfin availability is slowly degrading. At this burn rate, the monthly error budget
            will be exhausted in less than 1 week.

            **Current State:**
            - Burn Rate (1d): {{ $value | humanize }}x normal
            - Burn Rate (2h): {{ query "burn_rate:jellyfin:availability:2h" | first | value | humanize }}x normal
            - Error Budget Remaining: {{ query "error_budget:jellyfin:availability:budget_remaining * 100" | first | value | humanize }}%
            - Days Until Exhaustion: {{ query "error_budget:jellyfin:availability:days_remaining" | first | value | humanize }} days

            **Impact:** Gradual reliability degradation.

            **Action:** Monitor trend. Consider freezing non-critical changes to preserve budget.

      # TIER 4: INFO - Very Slow Burn (FYI only)
      # Budget exhausts in <2 weeks at this rate
      - alert: SLOBurnRateTier4_Jellyfin
        expr: |
          (
            burn_rate:jellyfin:availability:3d > 1.5
            and
            burn_rate:jellyfin:availability:1d > 1.5
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 259200)
        for: 6h
        labels:
          severity: info
          component: slo
          service: jellyfin
          slo: availability
          tier: "4"
          burn_rate: "minimal"
        annotations:
          summary: "â„¹ï¸ Jellyfin error budget trending above baseline"
          description: |
            **Informational - Long-term trend**

            Jellyfin availability is slightly below target. At this burn rate, the monthly error budget
            will be exhausted in approximately 2 weeks.

            **Current State:**
            - Burn Rate (3d): {{ $value | humanize }}x normal
            - Error Budget Remaining: {{ query "error_budget:jellyfin:availability:budget_remaining * 100" | first | value | humanize }}%
            - Days Until Exhaustion: {{ query "error_budget:jellyfin:availability:days_remaining" | first | value | humanize }} days

            **Action:** Review trends in monthly SLO report. No immediate action needed.

  # ===========================================================================
  # IMMICH - Multi-Window Burn Rate Alerts
  # ===========================================================================
  - name: slo_multiwindow_immich
    interval: 1m
    rules:
      # TIER 1: CRITICAL
      - alert: SLOBurnRateTier1_Immich
        expr: |
          (
            burn_rate:immich:availability:1h > 14.4
            and
            burn_rate:immich:availability:5m > 14.4
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 3600)
        for: 2m
        labels:
          severity: critical
          component: slo
          service: immich
          slo: availability
          tier: "1"
        annotations:
          summary: "ğŸš¨ CRITICAL: Immich error budget burning at 14.4x normal rate"
          description: |
            **IMMEDIATE ACTION REQUIRED**

            Immich availability is degrading rapidly. Error budget exhausts in <3 hours.

            - Burn Rate (1h): {{ $value | humanize }}x
            - Budget Remaining: {{ query "error_budget:immich:availability:budget_remaining * 100" | first | value | humanize }}%
            - Days Left: {{ query "error_budget:immich:availability:days_remaining" | first | value | humanize }}

            Action: systemctl --user status immich.service && podman logs immich --tail 100

      # TIER 2: WARNING
      - alert: SLOBurnRateTier2_Immich
        expr: |
          (
            burn_rate:immich:availability:6h > 6
            and
            burn_rate:immich:availability:30m > 6
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 21600)
        for: 15m
        labels:
          severity: warning
          component: slo
          service: immich
          slo: availability
          tier: "2"
        annotations:
          summary: "âš ï¸ Immich error budget burning at 6x normal rate"
          description: "Budget exhausts in <1 day. Burn: {{ $value | humanize }}x, Remaining: {{ query \"error_budget:immich:availability:budget_remaining * 100\" | first | value | humanize }}%"

      # TIER 3: WARNING
      - alert: SLOBurnRateTier3_Immich
        expr: |
          (
            burn_rate:immich:availability:1d > 3
            and
            burn_rate:immich:availability:2h > 3
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 86400)
        for: 1h
        labels:
          severity: warning
          component: slo
          service: immich
          slo: availability
          tier: "3"
        annotations:
          summary: "ğŸ“Š Immich error budget burning at 3x normal rate"
          description: "Budget exhausts in <1 week. Trend monitoring needed."

      # TIER 4: INFO
      - alert: SLOBurnRateTier4_Immich
        expr: |
          (
            burn_rate:immich:availability:3d > 1.5
            and
            burn_rate:immich:availability:1d > 1.5
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 259200)
        for: 6h
        labels:
          severity: info
          component: slo
          service: immich
          slo: availability
          tier: "4"
        annotations:
          summary: "â„¹ï¸ Immich error budget trending above baseline"
          description: "Long-term trend - review in monthly report."

  # ===========================================================================
  # AUTHELIA - Multi-Window Burn Rate Alerts (Critical SSO service)
  # ===========================================================================
  - name: slo_multiwindow_authelia
    interval: 1m
    rules:
      # TIER 1: CRITICAL
      - alert: SLOBurnRateTier1_Authelia
        expr: |
          (
            burn_rate:authelia:availability:1h > 14.4
            and
            burn_rate:authelia:availability:5m > 14.4
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 3600)
        for: 2m
        labels:
          severity: critical
          component: slo
          service: authelia
          slo: availability
          tier: "1"
        annotations:
          summary: "ğŸš¨ CRITICAL: Authelia (SSO) error budget burning at 14.4x normal rate"
          description: |
            **IMMEDIATE ACTION REQUIRED - SSO IS FAILING**

            Authelia (SSO) availability is degrading. Users cannot authenticate!

            - Burn Rate: {{ $value | humanize }}x
            - Budget Remaining: {{ query "error_budget:authelia:availability:budget_remaining * 100" | first | value | humanize }}%

            Action: systemctl --user status authelia.service redis-authelia.service

      # TIER 2-4: Similar pattern for Authelia...
      - alert: SLOBurnRateTier2_Authelia
        expr: |
          (
            burn_rate:authelia:availability:6h > 6
            and
            burn_rate:authelia:availability:30m > 6
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 21600)
        for: 15m
        labels:
          severity: warning
          component: slo
          service: authelia
          slo: availability
          tier: "2"
        annotations:
          summary: "âš ï¸ Authelia error budget burning at 6x normal rate"

      - alert: SLOBurnRateTier3_Authelia
        expr: |
          (
            burn_rate:authelia:availability:1d > 3
            and
            burn_rate:authelia:availability:2h > 3
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 86400)
        for: 1h
        labels:
          severity: warning
          component: slo
          service: authelia
          slo: availability
          tier: "3"
        annotations:
          summary: "ğŸ“Š Authelia error budget burning at 3x normal rate"

      - alert: SLOBurnRateTier4_Authelia
        expr: |
          (
            burn_rate:authelia:availability:3d > 1.5
            and
            burn_rate:authelia:availability:1d > 1.5
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 259200)
        for: 6h
        labels:
          severity: info
          component: slo
          service: authelia
          slo: availability
          tier: "4"
        annotations:
          summary: "â„¹ï¸ Authelia error budget trending above baseline"

  # ===========================================================================
  # HOME ASSISTANT - Multi-Window Burn Rate Alerts
  # WebSocket-heavy service (code=0 counted as success in recording rules)
  # ===========================================================================
  - name: slo_multiwindow_home_assistant
    interval: 1m
    rules:
      # TIER 1: CRITICAL - Fast Burn (Page immediately)
      - alert: SLOBurnRateTier1_HomeAssistant
        expr: |
          (
            burn_rate:home_assistant:availability:1h > 14.4
            and
            burn_rate:home_assistant:availability:5m > 14.4
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 3600)
        for: 2m
        labels:
          severity: critical
          component: slo
          service: home-assistant
          slo: availability
          tier: "1"
          burn_rate: "fast"
        annotations:
          summary: "ğŸš¨ CRITICAL: Home Assistant error budget burning at 14.4x normal rate"
          description: |
            **IMMEDIATE ACTION REQUIRED**

            Home Assistant availability is degrading rapidly. At this burn rate, the monthly error budget
            will be exhausted in less than 3 hours.

            **Current State:**
            - Burn Rate (1h): {{ $value | humanize }}x normal
            - Burn Rate (5m): {{ query "burn_rate:home_assistant:availability:5m" | first | value | humanize }}x normal
            - Error Budget Remaining: {{ query "error_budget:home_assistant:availability:budget_remaining * 100" | first | value | humanize }}%
            - Days Until Exhaustion: {{ query "error_budget:home_assistant:availability:days_remaining" | first | value | humanize }} days

            **Impact:** Smart home automations and device control failing RIGHT NOW.

            **Action:** Investigate and resolve immediately. Check:
              systemctl --user status home-assistant.service
              podman logs home-assistant --tail 100
              ~/containers/scripts/homelab-intel.sh

      # TIER 2: WARNING - Medium Burn (Create ticket)
      - alert: SLOBurnRateTier2_HomeAssistant
        expr: |
          (
            burn_rate:home_assistant:availability:6h > 6
            and
            burn_rate:home_assistant:availability:30m > 6
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 21600)
        for: 15m
        labels:
          severity: warning
          component: slo
          service: home-assistant
          slo: availability
          tier: "2"
          burn_rate: "medium"
        annotations:
          summary: "âš ï¸ Home Assistant error budget burning at 6x normal rate"
          description: |
            **Action needed within hours**

            Home Assistant availability is degrading. At this burn rate, the monthly error budget
            will be exhausted in less than 1 day.

            **Current State:**
            - Burn Rate (6h): {{ $value | humanize }}x normal
            - Burn Rate (30m): {{ query "burn_rate:home_assistant:availability:30m" | first | value | humanize }}x normal
            - Error Budget Remaining: {{ query "error_budget:home_assistant:availability:budget_remaining * 100" | first | value | humanize }}%

            **Action:** Investigate and plan remediation.

      # TIER 3: WARNING - Slow Burn (Plan remediation)
      - alert: SLOBurnRateTier3_HomeAssistant
        expr: |
          (
            burn_rate:home_assistant:availability:1d > 3
            and
            burn_rate:home_assistant:availability:2h > 3
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 86400)
        for: 1h
        labels:
          severity: warning
          component: slo
          service: home-assistant
          slo: availability
          tier: "3"
          burn_rate: "slow"
        annotations:
          summary: "ğŸ“Š Home Assistant error budget burning at 3x normal rate"
          description: |
            **Trend to monitor**

            Home Assistant availability is slowly degrading. Budget exhausts in <1 week.

            - Burn Rate (1d): {{ $value | humanize }}x normal
            - Budget Remaining: {{ query "error_budget:home_assistant:availability:budget_remaining * 100" | first | value | humanize }}%

      # TIER 4: INFO - Very Slow Burn (FYI only)
      - alert: SLOBurnRateTier4_HomeAssistant
        expr: |
          (
            burn_rate:home_assistant:availability:3d > 1.5
            and
            burn_rate:home_assistant:availability:1d > 1.5
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 259200)
        for: 6h
        labels:
          severity: info
          component: slo
          service: home-assistant
          slo: availability
          tier: "4"
          burn_rate: "minimal"
        annotations:
          summary: "â„¹ï¸ Home Assistant error budget trending above baseline"

  # ===========================================================================
  # NEXTCLOUD - Multi-Window Burn Rate Alerts
  # ===========================================================================
  - name: slo_multiwindow_nextcloud
    interval: 1m
    rules:
      # TIER 1: CRITICAL - Fast Burn (Page immediately)
      # Budget exhausts in <3 hours at this rate
      - alert: SLOBurnRateTier1_Nextcloud
        expr: |
          (
            burn_rate:nextcloud:availability:1h > 14.4
            and
            burn_rate:nextcloud:availability:5m > 14.4
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 3600)
        for: 2m
        labels:
          severity: critical
          component: slo
          service: nextcloud
          slo: availability
          tier: "1"
          burn_rate: "fast"
        annotations:
          summary: "ğŸš¨ CRITICAL: Nextcloud error budget burning at 14.4x normal rate"
          description: |
            **IMMEDIATE ACTION REQUIRED**

            Nextcloud availability is degrading rapidly. At this burn rate, the monthly error budget
            will be exhausted in less than 3 hours.

            **Current State:**
            - Burn Rate (1h): {{ $value | humanize }}x normal
            - Burn Rate (5m): {{ query "burn_rate:nextcloud:availability:5m" | first | value | humanize }}x normal
            - Error Budget Remaining: {{ query "error_budget:nextcloud:availability:budget_remaining * 100" | first | value | humanize }}%
            - Days Until Exhaustion: {{ query "error_budget:nextcloud:availability:days_remaining" | first | value | humanize }} days

            **Impact:** Users cannot access files, calendars, or contacts RIGHT NOW.

            **Action:** Investigate and resolve immediately. Check:
              systemctl --user status nextcloud.service nextcloud-db.service nextcloud-redis.service
              podman logs nextcloud --tail 100
              ~/containers/scripts/homelab-intel.sh

      # TIER 2: WARNING - Medium Burn (Create ticket)
      # Budget exhausts in <1 day at this rate
      - alert: SLOBurnRateTier2_Nextcloud
        expr: |
          (
            burn_rate:nextcloud:availability:6h > 6
            and
            burn_rate:nextcloud:availability:30m > 6
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 21600)
        for: 15m
        labels:
          severity: warning
          component: slo
          service: nextcloud
          slo: availability
          tier: "2"
          burn_rate: "medium"
        annotations:
          summary: "âš ï¸ Nextcloud error budget burning at 6x normal rate"
          description: |
            **Action needed within hours**

            Nextcloud availability is degrading. At this burn rate, the monthly error budget
            will be exhausted in less than 1 day.

            **Current State:**
            - Burn Rate (6h): {{ $value | humanize }}x normal
            - Burn Rate (30m): {{ query "burn_rate:nextcloud:availability:30m" | first | value | humanize }}x normal
            - Error Budget Remaining: {{ query "error_budget:nextcloud:availability:budget_remaining * 100" | first | value | humanize }}%
            - Days Until Exhaustion: {{ query "error_budget:nextcloud:availability:days_remaining" | first | value | humanize }} days

            **Impact:** Increased error rate, degraded file sync and CalDAV/CardDAV.

            **Action:** Investigate and plan remediation. This can wait until business hours
            but should not be ignored.

      # TIER 3: WARNING - Slow Burn (Plan remediation)
      # Budget exhausts in <1 week at this rate
      - alert: SLOBurnRateTier3_Nextcloud
        expr: |
          (
            burn_rate:nextcloud:availability:1d > 3
            and
            burn_rate:nextcloud:availability:2h > 3
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 86400)
        for: 1h
        labels:
          severity: warning
          component: slo
          service: nextcloud
          slo: availability
          tier: "3"
          burn_rate: "slow"
        annotations:
          summary: "ğŸ“Š Nextcloud error budget burning at 3x normal rate"
          description: |
            **Trend to monitor**

            Nextcloud availability is slowly degrading. At this burn rate, the monthly error budget
            will be exhausted in less than 1 week.

            **Current State:**
            - Burn Rate (1d): {{ $value | humanize }}x normal
            - Burn Rate (2h): {{ query "burn_rate:nextcloud:availability:2h" | first | value | humanize }}x normal
            - Error Budget Remaining: {{ query "error_budget:nextcloud:availability:budget_remaining * 100" | first | value | humanize }}%
            - Days Until Exhaustion: {{ query "error_budget:nextcloud:availability:days_remaining" | first | value | humanize }} days

            **Impact:** Gradual reliability degradation.

            **Action:** Monitor trend. Consider investigating rate limiting or database performance.

      # TIER 4: INFO - Very Slow Burn (FYI only)
      # Budget exhausts in <2 weeks at this rate
      - alert: SLOBurnRateTier4_Nextcloud
        expr: |
          (
            burn_rate:nextcloud:availability:3d > 1.5
            and
            burn_rate:nextcloud:availability:1d > 1.5
          )
          and
          (time() - process_start_time_seconds{job="prometheus"} > 259200)
        for: 6h
        labels:
          severity: info
          component: slo
          service: nextcloud
          slo: availability
          tier: "4"
        annotations:
          summary: "â„¹ï¸ Nextcloud error budget trending above baseline"
