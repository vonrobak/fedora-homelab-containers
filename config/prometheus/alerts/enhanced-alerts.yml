# Enhanced Discord Alerts - Prospect #4
# Created: 2025-11-24
# Updated: 2025-12-05 - Removed noisy scheduled alerts, tuned thresholds
# Focus: Proactive monitoring

groups:
  - name: container_health
    interval: 30s
    rules:
      # Warning: Container memory pressure (using >95% of limit)
      # Raised threshold from 90% to 95% - databases often run at 85-92% by design
      # Hysteresis: Fire >95%, resolve <90% (prevents flapping)
      - alert: ContainerMemoryPressure
        expr: |
          (
            (
              container_memory_working_set_bytes{name!~"POD|pause"}
              /
              container_spec_memory_limit_bytes{name!~"POD|pause"}
            ) > 0.95
            and
            ALERTS{alertname="ContainerMemoryPressure"} != 1
          )
          or
          (
            (
              container_memory_working_set_bytes{name!~"POD|pause"}
              /
              container_spec_memory_limit_bytes{name!~"POD|pause"}
            ) > 0.90
            and
            ALERTS{alertname="ContainerMemoryPressure"} == 1
          )
          and container_spec_memory_limit_bytes > 0
        for: 15m
        labels:
          severity: warning
          component: container
        annotations:
          summary: "Container {{ $labels.name }} memory pressure high"
          description: "Container {{ $labels.name }} is using {{ $value | humanizePercentage }} of its memory limit. May be at risk of OOM kill."

      # Warning: Container not running (expected to be up)
      - alert: ContainerNotRunning
        expr: |
          (
            time() - container_last_seen{name!~"POD|pause"} > 300
          )
        for: 5m
        labels:
          severity: warning
          component: container
        annotations:
          summary: "Container {{ $labels.name }} not running"
          description: "Container {{ $labels.name }} has not been seen for more than 5 minutes. It may have crashed or been stopped."

  # Removed certificate_health group - CertificateRenewalHealthCheck was creating
  # noise during normal operation. Actual cert expiry alerts remain in rules.yml

  - name: network_security
    interval: 5m
    rules:
      # CrowdSec ban spike (potential attack)
      - alert: CrowdSecBanSpike
        expr: |
          (
            rate(crowdsec_decisions_total[1h]) > 10
          )
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "CrowdSec ban rate spike detected"
          description: "CrowdSec is banning IPs at {{ $value | humanize }} per hour. This may indicate an active attack or scan."

      # CrowdSec service health
      - alert: CrowdSecDown
        expr: up{job="crowdsec"} == 0
        for: 5m
        labels:
          severity: critical
          component: security
        annotations:
          summary: "CrowdSec security monitoring is down"
          description: "CrowdSec has been unreachable for more than 5 minutes. IP reputation filtering is disabled!"

  - name: system_performance
    interval: 1m
    rules:
      # Removed WeeklyResourceDigest - scheduled reports should use systemd timers,
      # not Prometheus alerts. See: ~/containers/scripts/weekly-intelligence-report.sh

      # Warning: Sustained high system load
      # Hysteresis: Fire >1.5x, resolve <1.3x (prevents flapping)
      - alert: HighSystemLoad
        expr: |
          (
            node_load15 / count(node_cpu_seconds_total{mode="idle"}) > 1.5
            and
            ALERTS{alertname="HighSystemLoad"} != 1
          )
          or
          (
            node_load15 / count(node_cpu_seconds_total{mode="idle"}) > 1.3
            and
            ALERTS{alertname="HighSystemLoad"} == 1
          )
        for: 15m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High system load sustained for 15+ minutes"
          description: "15-minute load average is {{ $value | humanize }}x CPU count. System may be overloaded."
