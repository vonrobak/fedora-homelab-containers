# SLO Recording Rules
# Created: 2025-11-27
# Updated: 2026-02-07 - Fix WebSocket code=0 counted as failure, upload NaN, Immich SLO target
# Purpose: Pre-calculate Service Level Indicators for efficient querying
#
# Note: Traefik reports WebSocket connections as code="0" (not HTTP status).
# These are successful connections and must be included in success counts.
# Affected services: Immich, Jellyfin, Home Assistant (any with WS support).

groups:
  # ===========================================================================
  # AVAILABILITY SLIs (Success Rate)
  # ===========================================================================
  - name: sli_availability
    interval: 30s
    rules:
      # Jellyfin - Total requests
      - record: sli:jellyfin:requests:total
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[5m]))

      # Jellyfin - Successful requests (2xx/3xx + WebSocket code=0)
      - record: sli:jellyfin:requests:success
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="jellyfin@file", code=~"0|2..|3.."}[5m]))

      # Jellyfin - Availability (use 30d SLO for current display)
      - record: sli:jellyfin:availability:ratio
        expr: slo:jellyfin:availability:actual

      # Immich - Total requests
      - record: sli:immich:requests:total
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="immich@file"}[5m]))

      # Immich - Successful requests (2xx/3xx + WebSocket code=0)
      - record: sli:immich:requests:success
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="immich@file", code=~"0|2..|3.."}[5m]))

      # Immich - Availability (use 30d SLO for current display)
      - record: sli:immich:availability:ratio
        expr: slo:immich:availability:actual

      # Authelia - Total requests
      - record: sli:authelia:requests:total
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[5m]))

      # Authelia - Successful requests (2xx/3xx + WebSocket code=0)
      - record: sli:authelia:requests:success
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="authelia@file", code=~"0|2..|3.."}[5m]))

      # Authelia - Availability (use 30d SLO for current display)
      - record: sli:authelia:availability:ratio
        expr: slo:authelia:availability:actual

      # Nextcloud - Total requests
      - record: sli:nextcloud:requests:total
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[5m]))

      # Nextcloud - Successful requests (2xx/3xx + WebSocket code=0)
      - record: sli:nextcloud:requests:success
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="nextcloud@file", code=~"0|2..|3.."}[5m]))

      # Nextcloud - Availability (use 30d SLO for current display)
      - record: sli:nextcloud:availability:ratio
        expr: slo:nextcloud:availability:actual

      # Home Assistant - Total requests
      - record: sli:home_assistant:requests:total
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[5m]))

      # Home Assistant - Successful requests (2xx/3xx + WebSocket code=0)
      # HA uses heavy WebSocket for real-time updates - code=0 is critical here
      - record: sli:home_assistant:requests:success
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="home-assistant@file", code=~"0|2..|3.."}[5m]))

      # Home Assistant - Availability (use 30d SLO for current display)
      - record: sli:home_assistant:availability:ratio
        expr: slo:home_assistant:availability:actual

      # Navidrome - Total requests
      - record: sli:navidrome:requests:total
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[5m]))

      # Navidrome - Successful requests (2xx/3xx)
      - record: sli:navidrome:requests:success
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="navidrome@file", code=~"0|2..|3.."}[5m]))

      # Navidrome - Availability (use 30d SLO for current display)
      - record: sli:navidrome:availability:ratio
        expr: slo:navidrome:availability:actual

      # Audiobookshelf - Total requests
      - record: sli:audiobookshelf:requests:total
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[5m]))

      # Audiobookshelf - Successful requests (2xx/3xx)
      - record: sli:audiobookshelf:requests:success
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file", code=~"0|2..|3.."}[5m]))

      # Audiobookshelf - Availability (use 30d SLO for current display)
      - record: sli:audiobookshelf:availability:ratio
        expr: slo:audiobookshelf:availability:actual

      # Traefik Gateway - Uptime
      - record: sli:traefik:availability:ratio
        expr: |
          scalar(avg_over_time(up{job="traefik"}[5m]))

  # ===========================================================================
  # LATENCY SLIs (Response Time)
  # ===========================================================================
  - name: sli_latency
    interval: 30s
    rules:
      # Jellyfin - p95 latency (requests completing under 500ms)
      - record: sli:jellyfin:latency:p95
        expr: |
          histogram_quantile(0.95,
            sum(rate(traefik_service_request_duration_seconds_bucket{exported_service="jellyfin@file"}[5m])) by (le)
          )

      # Jellyfin - Requests under 500ms target
      - record: sli:jellyfin:latency:fast_ratio
        expr: |
          sum(rate(traefik_service_request_duration_seconds_bucket{exported_service="jellyfin@file", le="0.5"}[5m]))
          /
          sum(rate(traefik_service_request_duration_seconds_count{exported_service="jellyfin@file"}[5m]))

      # Authelia - p95 latency
      - record: sli:authelia:latency:p95
        expr: |
          histogram_quantile(0.95,
            sum(rate(traefik_service_request_duration_seconds_bucket{exported_service="authelia@file"}[5m])) by (le)
          )

      # Authelia - Requests under 200ms target
      - record: sli:authelia:latency:fast_ratio
        expr: |
          sum(rate(traefik_service_request_duration_seconds_bucket{exported_service="authelia@file", le="0.2"}[5m]))
          /
          sum(rate(traefik_service_request_duration_seconds_count{exported_service="authelia@file"}[5m]))

      # Nextcloud - p95 latency
      - record: sli:nextcloud:latency:p95
        expr: |
          histogram_quantile(0.95,
            sum(rate(traefik_service_request_duration_seconds_bucket{exported_service="nextcloud@file"}[5m])) by (le)
          )

      # Nextcloud - Requests under 1000ms target (file sync can be slower)
      - record: sli:nextcloud:latency:fast_ratio
        expr: |
          sum(rate(traefik_service_request_duration_seconds_bucket{exported_service="nextcloud@file", le="1.0"}[5m]))
          /
          sum(rate(traefik_service_request_duration_seconds_count{exported_service="nextcloud@file"}[5m]))

      # Home Assistant - p95 latency
      - record: sli:home_assistant:latency:p95
        expr: |
          histogram_quantile(0.95,
            sum(rate(traefik_service_request_duration_seconds_bucket{exported_service="home-assistant@file"}[5m])) by (le)
          )

      # Home Assistant - Requests under 1000ms target (WebSocket-heavy, allow more latency)
      - record: sli:home_assistant:latency:fast_ratio
        expr: |
          sum(rate(traefik_service_request_duration_seconds_bucket{exported_service="home-assistant@file", le="1.0"}[5m]))
          /
          sum(rate(traefik_service_request_duration_seconds_count{exported_service="home-assistant@file"}[5m]))

      # Traefik - p99 entrypoint latency (all traffic)
      - record: sli:traefik:latency:p99
        expr: |
          histogram_quantile(0.99,
            sum(rate(traefik_entrypoint_request_duration_seconds_bucket[5m])) by (le)
          )

      # Traefik - Requests under 100ms target
      - record: sli:traefik:latency:fast_ratio
        expr: |
          sum(rate(traefik_entrypoint_request_duration_seconds_bucket{le="0.1"}[5m]))
          /
          sum(rate(traefik_entrypoint_request_duration_seconds_count[5m]))

  # ===========================================================================
  # UPLOAD/WRITE SUCCESS SLIs
  # ===========================================================================
  - name: sli_writes
    interval: 30s
    rules:
      # Immich - Upload success (POST/PUT/PATCH operations)
      - record: sli:immich:uploads:total
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="immich@file", method=~"POST|PUT|PATCH"}[5m]))

      - record: sli:immich:uploads:success
        expr: |
          sum(rate(traefik_service_requests_total{exported_service="immich@file", method=~"POST|PUT|PATCH", code=~"2.."}[5m]))

      # Returns 1.0 when no uploads (no failures = 100% success).
      # Avoids NaN by adding 1 to denominator when total is 0 (0/1=0),
      # then flipping 0->1 when total was 0. When total > 0, ratio is computed normally.
      - record: sli:immich:uploads:success_ratio
        expr: |
          clamp_max(
            sli:immich:uploads:success
            /
            clamp_min(sli:immich:uploads:total, 0.001)
            +
            (sli:immich:uploads:total < bool 0.001),
            1
          )

  # ===========================================================================
  # SLO COMPLIANCE (30-day rolling windows)
  # ===========================================================================
  - name: slo_compliance
    interval: 2m
    rules:
      # Jellyfin - 99.5% availability target over 30 days
      - record: slo:jellyfin:availability:target
        expr: 0.995

      - record: slo:jellyfin:availability:actual
        expr: |
          (
            sum(increase(traefik_service_requests_total{exported_service="jellyfin@file", code=~"0|2..|3.."}[30d]))
            /
            sum(increase(traefik_service_requests_total{exported_service="jellyfin@file"}[30d]))
          )

      - record: slo:jellyfin:availability:compliant
        expr: |
          slo:jellyfin:availability:actual >= bool slo:jellyfin:availability:target

      # Immich - 99.5% availability target over 30 days
      # Lowered from 99.9%: at ~50 req/day, 99.9% allows only 1.5 failures/month
      # which is unrealistic. 99.5% allows ~7 failures/month (2.16 hours budget).
      - record: slo:immich:availability:target
        expr: 0.995

      - record: slo:immich:availability:actual
        expr: |
          (
            sum(increase(traefik_service_requests_total{exported_service="immich@file", code=~"0|2..|3.."}[30d]))
            /
            sum(increase(traefik_service_requests_total{exported_service="immich@file"}[30d]))
          )

      - record: slo:immich:availability:compliant
        expr: |
          slo:immich:availability:actual >= bool slo:immich:availability:target

      # Authelia - 99.9% availability target over 30 days
      - record: slo:authelia:availability:target
        expr: 0.999

      - record: slo:authelia:availability:actual
        expr: |
          (
            sum(increase(traefik_service_requests_total{exported_service="authelia@file", code=~"0|2..|3.."}[30d]))
            /
            sum(increase(traefik_service_requests_total{exported_service="authelia@file"}[30d]))
          )

      - record: slo:authelia:availability:compliant
        expr: |
          slo:authelia:availability:actual >= bool slo:authelia:availability:target

      # Nextcloud - 99.5% availability target over 30 days
      - record: slo:nextcloud:availability:target
        expr: 0.995

      - record: slo:nextcloud:availability:actual
        expr: |
          (
            sum(increase(traefik_service_requests_total{exported_service="nextcloud@file", code=~"0|2..|3.."}[30d]))
            /
            sum(increase(traefik_service_requests_total{exported_service="nextcloud@file"}[30d]))
          )

      - record: slo:nextcloud:availability:compliant
        expr: |
          slo:nextcloud:availability:actual >= bool slo:nextcloud:availability:target

      # Home Assistant - 99.5% availability target over 30 days
      # WebSocket-heavy service with native auth (no Authelia)
      - record: slo:home_assistant:availability:target
        expr: 0.995

      - record: slo:home_assistant:availability:actual
        expr: |
          (
            sum(increase(traefik_service_requests_total{exported_service="home-assistant@file", code=~"0|2..|3.."}[30d]))
            /
            sum(increase(traefik_service_requests_total{exported_service="home-assistant@file"}[30d]))
          )

      - record: slo:home_assistant:availability:compliant
        expr: |
          slo:home_assistant:availability:actual >= bool slo:home_assistant:availability:target

      # Navidrome - 99.5% availability target over 30 days
      # Music streaming service with Subsonic API, native auth
      - record: slo:navidrome:availability:target
        expr: 0.995

      - record: slo:navidrome:availability:actual
        expr: |
          (
            sum(increase(traefik_service_requests_total{exported_service="navidrome@file", code=~"0|2..|3.."}[30d]))
            /
            sum(increase(traefik_service_requests_total{exported_service="navidrome@file"}[30d]))
          )

      - record: slo:navidrome:availability:compliant
        expr: |
          slo:navidrome:availability:actual >= bool slo:navidrome:availability:target

      # Audiobookshelf - 99.5% availability target over 30 days
      # Audiobook/podcast service with native auth
      - record: slo:audiobookshelf:availability:target
        expr: 0.995

      - record: slo:audiobookshelf:availability:actual
        expr: |
          (
            sum(increase(traefik_service_requests_total{exported_service="audiobookshelf@file", code=~"0|2..|3.."}[30d]))
            /
            sum(increase(traefik_service_requests_total{exported_service="audiobookshelf@file"}[30d]))
          )

      - record: slo:audiobookshelf:availability:compliant
        expr: |
          slo:audiobookshelf:availability:actual >= bool slo:audiobookshelf:availability:target

      # Traefik - 99.95% availability target over 30 days
      - record: slo:traefik:availability:target
        expr: 0.9995

      - record: slo:traefik:availability:actual
        expr: |
          scalar(avg_over_time(up{job="traefik"}[30d]))

      - record: slo:traefik:availability:compliant
        expr: |
          slo:traefik:availability:actual >= bool slo:traefik:availability:target

  # ===========================================================================
  # ERROR BUDGET TRACKING
  # ===========================================================================
  - name: error_budget
    interval: 5m
    rules:
      # Jellyfin - Error budget (0.5% allowed failure = 216 min/month)
      - record: error_budget:jellyfin:availability:budget_total
        expr: 0.005

      - record: error_budget:jellyfin:availability:budget_consumed
        expr: |
          clamp_min(
            (1 - slo:jellyfin:availability:actual) / (1 - slo:jellyfin:availability:target),
            0
          )

      - record: error_budget:jellyfin:availability:budget_remaining
        expr: |
          clamp_max(1 - error_budget:jellyfin:availability:budget_consumed, 1)

      # Immich - Error budget (0.5% allowed failure = 216 min/month)
      - record: error_budget:immich:availability:budget_total
        expr: 0.005

      - record: error_budget:immich:availability:budget_consumed
        expr: |
          clamp_min(
            (1 - slo:immich:availability:actual) / (1 - slo:immich:availability:target),
            0
          )

      - record: error_budget:immich:availability:budget_remaining
        expr: |
          clamp_max(1 - error_budget:immich:availability:budget_consumed, 1)

      # Authelia - Error budget (0.1% = 43 min/month)
      - record: error_budget:authelia:availability:budget_total
        expr: 0.001

      - record: error_budget:authelia:availability:budget_consumed
        expr: |
          clamp_min(
            (1 - slo:authelia:availability:actual) / (1 - slo:authelia:availability:target),
            0
          )

      - record: error_budget:authelia:availability:budget_remaining
        expr: |
          clamp_max(1 - error_budget:authelia:availability:budget_consumed, 1)

      # Nextcloud - Error budget (0.5% allowed failure = 216 min/month)
      - record: error_budget:nextcloud:availability:budget_total
        expr: 0.005

      - record: error_budget:nextcloud:availability:budget_consumed
        expr: |
          clamp_min(
            (1 - slo:nextcloud:availability:actual) / (1 - slo:nextcloud:availability:target),
            0
          )

      - record: error_budget:nextcloud:availability:budget_remaining
        expr: |
          clamp_max(1 - error_budget:nextcloud:availability:budget_consumed, 1)

      # Home Assistant - Error budget (0.5% allowed failure = 216 min/month)
      - record: error_budget:home_assistant:availability:budget_total
        expr: 0.005

      - record: error_budget:home_assistant:availability:budget_consumed
        expr: |
          clamp_min(
            (1 - slo:home_assistant:availability:actual) / (1 - slo:home_assistant:availability:target),
            0
          )

      - record: error_budget:home_assistant:availability:budget_remaining
        expr: |
          clamp_max(1 - error_budget:home_assistant:availability:budget_consumed, 1)

      # Navidrome - Error budget (0.5% allowed failure = 216 min/month)
      - record: error_budget:navidrome:availability:budget_total
        expr: 0.005

      - record: error_budget:navidrome:availability:budget_consumed
        expr: |
          clamp_min(
            (1 - slo:navidrome:availability:actual) / (1 - slo:navidrome:availability:target),
            0
          )

      - record: error_budget:navidrome:availability:budget_remaining
        expr: |
          clamp_max(1 - error_budget:navidrome:availability:budget_consumed, 1)

      # Audiobookshelf - Error budget (0.5% allowed failure = 216 min/month)
      - record: error_budget:audiobookshelf:availability:budget_total
        expr: 0.005

      - record: error_budget:audiobookshelf:availability:budget_consumed
        expr: |
          clamp_min(
            (1 - slo:audiobookshelf:availability:actual) / (1 - slo:audiobookshelf:availability:target),
            0
          )

      - record: error_budget:audiobookshelf:availability:budget_remaining
        expr: |
          clamp_max(1 - error_budget:audiobookshelf:availability:budget_consumed, 1)

      # Traefik - Error budget (0.05% = 21 min/month)
      - record: error_budget:traefik:availability:budget_total
        expr: 0.0005

      - record: error_budget:traefik:availability:budget_consumed
        expr: |
          clamp_min(
            (1 - slo:traefik:availability:actual) / (1 - slo:traefik:availability:target),
            0
          )

      - record: error_budget:traefik:availability:budget_remaining
        expr: |
          clamp_max(1 - error_budget:traefik:availability:budget_consumed, 1)

  # ===========================================================================
  # BURN RATE CALCULATIONS (for multi-window alerting)
  # FIXED: 2026-01-22 - Calculate actual short-term failure rates, not 30-day averages
  # FIXED: 2026-02-26 - Use (total-success)/clamp_min(total) to avoid NaN when zero traffic
  # ===========================================================================
  - name: burn_rate
    interval: 1m
    rules:
      # Jellyfin - 1h burn rate (used for fast alerts)
      - record: burn_rate:jellyfin:availability:1h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[1h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="jellyfin@file", code=~"0|2..|3.."}[1h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[1h])), 1e-10)
          / error_budget:jellyfin:availability:budget_total

      # Jellyfin - 5m burn rate (used for fast alert confirmation)
      - record: burn_rate:jellyfin:availability:5m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[5m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="jellyfin@file", code=~"0|2..|3.."}[5m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[5m])), 1e-10)
          / error_budget:jellyfin:availability:budget_total

      # Jellyfin - 6h burn rate (used for slow alerts)
      - record: burn_rate:jellyfin:availability:6h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[6h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="jellyfin@file", code=~"0|2..|3.."}[6h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[6h])), 1e-10)
          / error_budget:jellyfin:availability:budget_total

      # Jellyfin - 30m burn rate (used for slow alert confirmation)
      - record: burn_rate:jellyfin:availability:30m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[30m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="jellyfin@file", code=~"0|2..|3.."}[30m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[30m])), 1e-10)
          / error_budget:jellyfin:availability:budget_total

      # Immich - Burn rates
      - record: burn_rate:immich:availability:1h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="immich@file"}[1h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="immich@file", code=~"0|2..|3.."}[1h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="immich@file"}[1h])), 1e-10)
          / error_budget:immich:availability:budget_total

      - record: burn_rate:immich:availability:5m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="immich@file"}[5m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="immich@file", code=~"0|2..|3.."}[5m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="immich@file"}[5m])), 1e-10)
          / error_budget:immich:availability:budget_total

      - record: burn_rate:immich:availability:6h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="immich@file"}[6h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="immich@file", code=~"0|2..|3.."}[6h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="immich@file"}[6h])), 1e-10)
          / error_budget:immich:availability:budget_total

      - record: burn_rate:immich:availability:30m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="immich@file"}[30m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="immich@file", code=~"0|2..|3.."}[30m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="immich@file"}[30m])), 1e-10)
          / error_budget:immich:availability:budget_total

      # Home Assistant - Burn rates (WebSocket-heavy, code=0 included)
      - record: burn_rate:home_assistant:availability:1h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[1h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="home-assistant@file", code=~"0|2..|3.."}[1h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[1h])), 1e-10)
          / error_budget:home_assistant:availability:budget_total

      - record: burn_rate:home_assistant:availability:5m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[5m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="home-assistant@file", code=~"0|2..|3.."}[5m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[5m])), 1e-10)
          / error_budget:home_assistant:availability:budget_total

      - record: burn_rate:home_assistant:availability:6h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[6h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="home-assistant@file", code=~"0|2..|3.."}[6h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[6h])), 1e-10)
          / error_budget:home_assistant:availability:budget_total

      - record: burn_rate:home_assistant:availability:30m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[30m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="home-assistant@file", code=~"0|2..|3.."}[30m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[30m])), 1e-10)
          / error_budget:home_assistant:availability:budget_total

      # Authelia - Burn rates
      - record: burn_rate:authelia:availability:1h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[1h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="authelia@file", code=~"0|2..|3.."}[1h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[1h])), 1e-10)
          / error_budget:authelia:availability:budget_total

      - record: burn_rate:authelia:availability:5m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[5m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="authelia@file", code=~"0|2..|3.."}[5m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[5m])), 1e-10)
          / error_budget:authelia:availability:budget_total

      - record: burn_rate:authelia:availability:6h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[6h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="authelia@file", code=~"0|2..|3.."}[6h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[6h])), 1e-10)
          / error_budget:authelia:availability:budget_total

      - record: burn_rate:authelia:availability:30m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[30m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="authelia@file", code=~"0|2..|3.."}[30m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[30m])), 1e-10)
          / error_budget:authelia:availability:budget_total

      # Nextcloud - Burn rates
      - record: burn_rate:nextcloud:availability:1h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[1h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="nextcloud@file", code=~"0|2..|3.."}[1h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[1h])), 1e-10)
          / error_budget:nextcloud:availability:budget_total

      - record: burn_rate:nextcloud:availability:5m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[5m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="nextcloud@file", code=~"0|2..|3.."}[5m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[5m])), 1e-10)
          / error_budget:nextcloud:availability:budget_total

      - record: burn_rate:nextcloud:availability:6h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[6h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="nextcloud@file", code=~"0|2..|3.."}[6h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[6h])), 1e-10)
          / error_budget:nextcloud:availability:budget_total

      - record: burn_rate:nextcloud:availability:30m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[30m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="nextcloud@file", code=~"0|2..|3.."}[30m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[30m])), 1e-10)
          / error_budget:nextcloud:availability:budget_total

      # Navidrome - Burn rates
      - record: burn_rate:navidrome:availability:1h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[1h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file", code=~"0|2..|3.."}[1h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[1h])), 1e-10)
          / error_budget:navidrome:availability:budget_total

      - record: burn_rate:navidrome:availability:5m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[5m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file", code=~"0|2..|3.."}[5m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[5m])), 1e-10)
          / error_budget:navidrome:availability:budget_total

      - record: burn_rate:navidrome:availability:6h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[6h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file", code=~"0|2..|3.."}[6h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[6h])), 1e-10)
          / error_budget:navidrome:availability:budget_total

      - record: burn_rate:navidrome:availability:30m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[30m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file", code=~"0|2..|3.."}[30m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[30m])), 1e-10)
          / error_budget:navidrome:availability:budget_total

      # Audiobookshelf - Burn rates
      - record: burn_rate:audiobookshelf:availability:1h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[1h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file", code=~"0|2..|3.."}[1h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[1h])), 1e-10)
          / error_budget:audiobookshelf:availability:budget_total

      - record: burn_rate:audiobookshelf:availability:5m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[5m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file", code=~"0|2..|3.."}[5m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[5m])), 1e-10)
          / error_budget:audiobookshelf:availability:budget_total

      - record: burn_rate:audiobookshelf:availability:6h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[6h]))
            -
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file", code=~"0|2..|3.."}[6h]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[6h])), 1e-10)
          / error_budget:audiobookshelf:availability:budget_total

      - record: burn_rate:audiobookshelf:availability:30m
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[30m]))
            -
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file", code=~"0|2..|3.."}[30m]))
          )
          / clamp_min(sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[30m])), 1e-10)
          / error_budget:audiobookshelf:availability:budget_total

      # Traefik - Burn rates (uses up metric, always has data, no NaN risk)
      - record: burn_rate:traefik:availability:1h
        expr: |
          (1 - avg_over_time(up{job="traefik"}[1h]))
          / error_budget:traefik:availability:budget_total

      - record: burn_rate:traefik:availability:5m
        expr: |
          (1 - avg_over_time(up{job="traefik"}[5m]))
          / error_budget:traefik:availability:budget_total

      - record: burn_rate:traefik:availability:6h
        expr: |
          (1 - avg_over_time(up{job="traefik"}[6h]))
          / error_budget:traefik:availability:budget_total

      - record: burn_rate:traefik:availability:30m
        expr: |
          (1 - avg_over_time(up{job="traefik"}[30m]))
          / error_budget:traefik:availability:budget_total
