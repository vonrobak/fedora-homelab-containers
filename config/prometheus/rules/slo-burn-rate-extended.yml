# Extended Burn Rate Recording Rules
# Created: 2025-12-19
# FIXED: 2026-01-22 - Calculate actual short-term failure rates, not 30-day averages
# FIXED: 2026-02-07 - Include WebSocket code=0 as successful (was counted as failure)
# FIXED: 2026-03-01 - Navidrome/Audiobookshelf: count only 5xx as errors
# Purpose: Add longer time windows for multi-tier burn rate detection
#
# Burn Rate Tiers (Google SRE Book methodology):
# - 1h + 5m: Critical (page) - Budget exhausts in <3 hours
# - 6h + 30m: High (ticket) - Budget exhausts in <1 day
# - 1d + 2h: Medium (ticket) - Budget exhausts in <1 week
# - 3d + 6h: Low (info) - Budget exhausts in <2 weeks

groups:
  - name: burn_rate_extended
    interval: 5m
    rules:
      # ===========================================================================
      # JELLYFIN - Extended burn rate windows
      # ===========================================================================

      # 1-day burn rate (medium-term trend)
      - record: burn_rate:jellyfin:availability:1d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="jellyfin@file", code=~"0|2..|3.."}[1d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[1d]))
            )
          ) / error_budget:jellyfin:availability:budget_total

      # 2-hour burn rate (medium-term confirmation)
      - record: burn_rate:jellyfin:availability:2h
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="jellyfin@file", code=~"0|2..|3.."}[2h]))
              /
              sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[2h]))
            )
          ) / error_budget:jellyfin:availability:budget_total

      # 3-day burn rate (long-term trend)
      - record: burn_rate:jellyfin:availability:3d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="jellyfin@file", code=~"0|2..|3.."}[3d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="jellyfin@file"}[3d]))
            )
          ) / error_budget:jellyfin:availability:budget_total

      # ===========================================================================
      # IMMICH - Extended burn rate windows
      # ===========================================================================

      - record: burn_rate:immich:availability:1d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="immich@file", code=~"0|2..|3.."}[1d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="immich@file"}[1d]))
            )
          ) / error_budget:immich:availability:budget_total

      - record: burn_rate:immich:availability:2h
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="immich@file", code=~"0|2..|3.."}[2h]))
              /
              sum(rate(traefik_service_requests_total{exported_service="immich@file"}[2h]))
            )
          ) / error_budget:immich:availability:budget_total

      - record: burn_rate:immich:availability:3d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="immich@file", code=~"0|2..|3.."}[3d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="immich@file"}[3d]))
            )
          ) / error_budget:immich:availability:budget_total

      # ===========================================================================
      # HOME ASSISTANT - Extended burn rate windows
      # ===========================================================================

      - record: burn_rate:home_assistant:availability:1d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="home-assistant@file", code=~"0|2..|3.."}[1d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[1d]))
            )
          ) / error_budget:home_assistant:availability:budget_total

      - record: burn_rate:home_assistant:availability:2h
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="home-assistant@file", code=~"0|2..|3.."}[2h]))
              /
              sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[2h]))
            )
          ) / error_budget:home_assistant:availability:budget_total

      - record: burn_rate:home_assistant:availability:3d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="home-assistant@file", code=~"0|2..|3.."}[3d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="home-assistant@file"}[3d]))
            )
          ) / error_budget:home_assistant:availability:budget_total

      # ===========================================================================
      # AUTHELIA - Extended burn rate windows
      # ===========================================================================

      - record: burn_rate:authelia:availability:1d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="authelia@file", code=~"0|2..|3.."}[1d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[1d]))
            )
          ) / error_budget:authelia:availability:budget_total

      - record: burn_rate:authelia:availability:2h
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="authelia@file", code=~"0|2..|3.."}[2h]))
              /
              sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[2h]))
            )
          ) / error_budget:authelia:availability:budget_total

      - record: burn_rate:authelia:availability:3d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="authelia@file", code=~"0|2..|3.."}[3d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="authelia@file"}[3d]))
            )
          ) / error_budget:authelia:availability:budget_total

      # ===========================================================================
      # NAVIDROME - Extended burn rate windows (only 5xx = errors)
      # ===========================================================================

      - record: burn_rate:navidrome:availability:1d
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file", code=~"5.."}[1d]))
            /
            clamp_min(sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[1d])), 1e-10)
          ) / error_budget:navidrome:availability:budget_total

      - record: burn_rate:navidrome:availability:2h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file", code=~"5.."}[2h]))
            /
            clamp_min(sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[2h])), 1e-10)
          ) / error_budget:navidrome:availability:budget_total

      - record: burn_rate:navidrome:availability:3d
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="navidrome@file", code=~"5.."}[3d]))
            /
            clamp_min(sum(rate(traefik_service_requests_total{exported_service="navidrome@file"}[3d])), 1e-10)
          ) / error_budget:navidrome:availability:budget_total

      # ===========================================================================
      # AUDIOBOOKSHELF - Extended burn rate windows (only 5xx = errors)
      # ===========================================================================

      - record: burn_rate:audiobookshelf:availability:1d
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file", code=~"5.."}[1d]))
            /
            clamp_min(sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[1d])), 1e-10)
          ) / error_budget:audiobookshelf:availability:budget_total

      - record: burn_rate:audiobookshelf:availability:2h
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file", code=~"5.."}[2h]))
            /
            clamp_min(sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[2h])), 1e-10)
          ) / error_budget:audiobookshelf:availability:budget_total

      - record: burn_rate:audiobookshelf:availability:3d
        expr: |
          (
            sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file", code=~"5.."}[3d]))
            /
            clamp_min(sum(rate(traefik_service_requests_total{exported_service="audiobookshelf@file"}[3d])), 1e-10)
          ) / error_budget:audiobookshelf:availability:budget_total

      # ===========================================================================
      # TRAEFIK - Extended burn rate windows (using up metric)
      # ===========================================================================

      - record: burn_rate:traefik:availability:1d
        expr: |
          (1 - avg_over_time(up{job="traefik"}[1d]))
          / error_budget:traefik:availability:budget_total

      - record: burn_rate:traefik:availability:2h
        expr: |
          (1 - avg_over_time(up{job="traefik"}[2h]))
          / error_budget:traefik:availability:budget_total

      - record: burn_rate:traefik:availability:3d
        expr: |
          (1 - avg_over_time(up{job="traefik"}[3d]))
          / error_budget:traefik:availability:budget_total

      # ===========================================================================
      # NEXTCLOUD - Extended burn rate windows
      # ===========================================================================

      - record: burn_rate:nextcloud:availability:1d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="nextcloud@file", code=~"0|2..|3.."}[1d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[1d]))
            )
          ) / error_budget:nextcloud:availability:budget_total

      - record: burn_rate:nextcloud:availability:2h
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="nextcloud@file", code=~"0|2..|3.."}[2h]))
              /
              sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[2h]))
            )
          ) / error_budget:nextcloud:availability:budget_total

      - record: burn_rate:nextcloud:availability:3d
        expr: |
          (
            1 - (
              sum(rate(traefik_service_requests_total{exported_service="nextcloud@file", code=~"0|2..|3.."}[3d]))
              /
              sum(rate(traefik_service_requests_total{exported_service="nextcloud@file"}[3d]))
            )
          ) / error_budget:nextcloud:availability:budget_total

      # ===========================================================================
      # ERROR BUDGET FORECASTING
      # ===========================================================================

      # Jellyfin - Predict when error budget will exhaust based on current burn rate
      - record: error_budget:jellyfin:availability:days_remaining
        expr: |
          (
            error_budget:jellyfin:availability:budget_remaining
            /
            clamp_min(burn_rate:jellyfin:availability:3d, 0.001)
          ) * 30

      # Immich - Days until budget exhaustion
      - record: error_budget:immich:availability:days_remaining
        expr: |
          (
            error_budget:immich:availability:budget_remaining
            /
            clamp_min(burn_rate:immich:availability:3d, 0.001)
          ) * 30

      # Authelia - Days until budget exhaustion
      - record: error_budget:authelia:availability:days_remaining
        expr: |
          (
            error_budget:authelia:availability:budget_remaining
            /
            clamp_min(burn_rate:authelia:availability:3d, 0.001)
          ) * 30

      # Traefik - Days until budget exhaustion
      - record: error_budget:traefik:availability:days_remaining
        expr: |
          (
            error_budget:traefik:availability:budget_remaining
            /
            clamp_min(burn_rate:traefik:availability:3d, 0.001)
          ) * 30

      # Home Assistant - Days until budget exhaustion
      - record: error_budget:home_assistant:availability:days_remaining
        expr: |
          (
            error_budget:home_assistant:availability:budget_remaining
            /
            clamp_min(burn_rate:home_assistant:availability:3d, 0.001)
          ) * 30

      # Navidrome - Days until budget exhaustion
      - record: error_budget:navidrome:availability:days_remaining
        expr: |
          (
            error_budget:navidrome:availability:budget_remaining
            /
            clamp_min(burn_rate:navidrome:availability:3d, 0.001)
          ) * 30

      # Audiobookshelf - Days until budget exhaustion
      - record: error_budget:audiobookshelf:availability:days_remaining
        expr: |
          (
            error_budget:audiobookshelf:availability:budget_remaining
            /
            clamp_min(burn_rate:audiobookshelf:availability:3d, 0.001)
          ) * 30

      # Nextcloud - Days until budget exhaustion
      - record: error_budget:nextcloud:availability:days_remaining
        expr: |
          (
            error_budget:nextcloud:availability:budget_remaining
            /
            clamp_min(burn_rate:nextcloud:availability:3d, 0.001)
          ) * 30
