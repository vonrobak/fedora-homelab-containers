# Prometheus Configuration for Homelab
# Last Updated: 2025-11-06

global:
  scrape_interval: 15s      # How often to scrape targets
  evaluation_interval: 15s  # How often to evaluate rules
  external_labels:
    cluster: 'homelab'
    environment: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# Load alerting and recording rules
rule_files:
  - "alerts/*.yml"
  - "rules/*.yml"

# Scrape configurations
scrape_configs:
  # Prometheus itself (self-monitoring)
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          instance: 'fedora-htpc'
          service: 'prometheus'

  # Node Exporter (system metrics)
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['node_exporter:9100']
        labels:
          instance: 'fedora-htpc'
          service: 'node_exporter'

  # Grafana monitoring
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
        labels:
          instance: 'fedora-htpc'
          service: 'grafana'

  # Traefik monitoring (metrics enabled 2025-11-06)
  - job_name: 'traefik'
    static_configs:
      - targets: ['traefik:8080']
        labels:
          instance: 'fedora-htpc'
          service: 'traefik'

  # Alertmanager monitoring
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
        labels:
          instance: 'fedora-htpc'
          service: 'alertmanager'

  # Loki log aggregation
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']
        labels:
          instance: 'fedora-htpc'
          service: 'loki'

  # Promtail log collector
  - job_name: 'promtail'
    static_configs:
      - targets: ['promtail:9080']
        labels:
          instance: 'fedora-htpc'
          service: 'promtail'

  # CrowdSec security monitoring
  - job_name: 'crowdsec'
    static_configs:
      - targets: ['crowdsec:6060']
        labels:
          instance: 'fedora-htpc'
          service: 'crowdsec'

  # cAdvisor - Container metrics exporter
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          instance: 'fedora-htpc'
          service: 'cadvisor'

  # Unpoller - UniFi Network metrics exporter
  - job_name: 'unpoller'
    static_configs:
      - targets: ['unpoller:9130']
        labels:
          instance: 'fedora-htpc'
          service: 'unpoller'

  # Nextcloud monitoring removed - ServerInfo endpoint requires auth
  # Nextcloud availability monitored via Traefik metrics (SLO recording rules)

  # Home Assistant - Home Automation Hub
  - job_name: 'home-assistant'
    static_configs:
      - targets: ['home-assistant:8123']
        labels:
          instance: 'fedora-htpc'
          service: 'home-assistant'
    metrics_path: '/api/prometheus'
    bearer_token: 'PLACEHOLDER_TOKEN'  # TODO: Generate long-lived access token
