# Optimized SSH Server Configuration for Homelab
# Designed for: Hardware-backed authentication (YubiKey FIDO2)
# Compatible with: Fedora 43, Debian 12
# Last updated: 2025-11-05

# ============================================================================
# NETWORK & PROTOCOL
# ============================================================================

# Listen on default port (change if port forwarding from external)
Port 22

# Listen on all interfaces (restrict with firewall, not here)
#ListenAddress 0.0.0.0
#ListenAddress ::

# Use only SSH protocol 2 (protocol 1 is insecure)
Protocol 2

# IPv4 and IPv6
AddressFamily any

# ============================================================================
# AUTHENTICATION METHODS
# ============================================================================

# Public key authentication (REQUIRED - our primary method)
PubkeyAuthentication yes

# Disable password authentication (YubiKey required)
PasswordAuthentication no

# Disable challenge-response (prevents keyboard-interactive bypass)
KbdInteractiveAuthentication no
ChallengeResponseAuthentication no

# Disable empty passwords
PermitEmptyPasswords no

# Location of authorized keys
AuthorizedKeysFile .ssh/authorized_keys

# Disable host-based authentication
HostbasedAuthentication no
IgnoreRhosts yes

# Disable root login (use sudo instead)
PermitRootLogin no

# ============================================================================
# USER ACCESS CONTROL
# ============================================================================

# Restrict SSH access to specific user(s)
AllowUsers patriark

# Alternative: Use groups
#AllowGroups ssh-users

# Maximum authentication attempts before disconnecting
MaxAuthTries 3

# Maximum sessions per connection
MaxSessions 10

# ============================================================================
# CRYPTOGRAPHIC SECURITY
# ============================================================================

# Host keys (prefer ed25519, fallback to RSA 4096)
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key

# Key exchange algorithms (modern, secure)
# Note: Post-quantum (sntrup761x25519) requires OpenSSH 9.0+
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256

# Ciphers (AES-GCM preferred for performance + security)
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# MACs (message authentication codes)
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256

# ============================================================================
# SESSION SETTINGS
# ============================================================================

# Use kernel sandbox mechanisms (Fedora: SELinux, Debian: AppArmor)
UsePrivilegeSeparation sandbox

# Disconnect if user doesn't log in within 2 minutes
LoginGraceTime 2m

# Client keepalive (detect dead connections)
ClientAliveInterval 300
ClientAliveCountMax 2

# TCP keepalive (detect network issues)
TCPKeepAlive yes

# ============================================================================
# SECURITY FEATURES
# ============================================================================

# Prevent TCP forwarding if not needed (adjust per host)
# AllowTcpForwarding no
# AllowStreamLocalForwarding no
# GatewayPorts no

# Disable X11 forwarding (enable only if needed)
X11Forwarding no

# Disable agent forwarding by default (security risk)
AllowAgentForwarding no

# Disable user environment processing
PermitUserEnvironment no

# Strict mode (check file permissions on keys/config)
StrictModes yes

# ============================================================================
# LOGGING
# ============================================================================

# Logging level (VERBOSE logs fingerprints, helpful for auditing)
LogLevel VERBOSE

# Syslog facility
SyslogFacility AUTHPRIV

# ============================================================================
# BANNER & MESSAGES
# ============================================================================

# Print /etc/motd after successful login
PrintMotd no

# Print last login info
PrintLastLog yes

# Optional: Display pre-auth banner
#Banner /etc/ssh/sshd_banner

# ============================================================================
# SUBSYSTEMS
# ============================================================================

# SFTP subsystem (for file transfers)
Subsystem sftp /usr/libexec/openssh/sftp-server

# Alternative for Debian systems:
# Subsystem sftp /usr/lib/openssh/sftp-server

# ============================================================================
# HOST-SPECIFIC OVERRIDES
# ============================================================================

# Example: More restrictive settings for external-facing hosts
#Match Address 192.168.1.0/24
#    PasswordAuthentication no
#    AllowUsers patriark

# Example: Allow TCP forwarding for specific users
#Match User patriark
#    AllowTcpForwarding yes
#    AllowAgentForwarding yes

# ============================================================================
# NOTES FOR HOMELAB DEPLOYMENT
# ============================================================================

# 1. Debian (pihole) differences:
#    - Change Subsystem sftp path to: /usr/lib/openssh/sftp-server
#    - SyslogFacility might be AUTH instead of AUTHPRIV
#
# 2. Test config before applying:
#    sudo sshd -t -f /etc/ssh/sshd_config
#
# 3. Restart SSH after changes:
#    Fedora: sudo systemctl restart sshd
#    Debian: sudo systemctl restart ssh
#
# 4. Monitor logs after changes:
#    Fedora: sudo journalctl -u sshd -f
#    Debian: sudo journalctl -u ssh -f
#
# 5. Emergency access:
#    Keep a local console session open when testing!
#    If locked out, boot to single-user mode or use console.
