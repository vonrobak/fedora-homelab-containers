# CrowdSec Phase 4: Configuration Management Plan

**Version:** 1.0
**Last Updated:** 2025-11-12
**Prerequisites:** Phase 1 and optionally Phase 3 completed
**Estimated Time:** 45-60 minutes
**Risk Level:** Low (documentation and templates, no service changes)

---

## Table of Contents

1. [Overview](#overview)
2. [Objectives](#objectives)
3. [Philosophy: Configuration as Code](#philosophy-configuration-as-code)
4. [Phase 4.1: Configuration Inventory](#phase-41-configuration-inventory)
5. [Phase 4.2: Git Integration Strategy](#phase-42-git-integration-strategy)
6. [Phase 4.3: Template Creation](#phase-43-template-creation)
7. [Phase 4.4: Validation Framework](#phase-44-validation-framework)
8. [Phase 4.5: Backup and Restore Procedures](#phase-45-backup-and-restore-procedures)
9. [Phase 4.6: Documentation Standards](#phase-46-documentation-standards)
10. [Operational Procedures](#operational-procedures)

---

## Overview

### The Configuration Management Problem

CrowdSec has several critical configuration files that are:

1. **Not tracked in Git** (located in `~/containers/data/crowdsec/config/`)
2. **Essential for security posture** (whitelist, ban profiles, parsers)
3. **Prone to drift** (manual changes not documented)
4. **Difficult to restore** (no version history)
5. **Hard to replicate** (setting up new instances requires manual work)

### Current State vs Desired State

**Current State:**
```
~/containers/data/crowdsec/config/
├── profiles.yaml              ❌ Not in Git
├── parsers/
│   └── s02-enrich/
│       └── local-whitelist.yaml  ❌ Not in Git
├── scenarios/                 ✅ Managed by cscli hub
└── config.yaml               ⚠️  Auto-generated, should not track
```

**Desired State:**
```
Git Repository:
├── config/crowdsec/templates/
│   ├── profiles.yaml.template    ✅ Versioned
│   ├── local-whitelist.yaml.template  ✅ Versioned
│   └── README.md                 ✅ Documentation
└── scripts/
    ├── crowdsec-config-deploy.sh  ✅ Deployment automation
    ├── crowdsec-config-validate.sh  ✅ Validation
    └── crowdsec-backup.sh         ✅ Backup automation
```

### Benefits

**For You:**
- Version history of security configurations
- Easy rollback to known-good states
- Documentation of why changes were made
- Reproducible deployments

**For the Project:**
- Configuration as code principles
- Learning artifact (decisions documented)
- Disaster recovery capability
- Easier to get help (can share configs safely)

---

## Objectives

### Success Criteria

At completion:

1. ✅ All critical CrowdSec configs inventoried and documented
2. ✅ Config templates created and stored in Git
3. ✅ Deployment scripts for applying templates to production
4. ✅ Validation scripts to check config correctness
5. ✅ Automated backup procedures in place
6. ✅ Restore procedures tested and documented
7. ✅ Configuration change workflow documented

### Out of Scope

❌ **Not** tracking:
- `config.yaml` (auto-generated by CrowdSec)
- Database files (`*.db`)
- LAPI credentials (secrets management)
- Decision cache (ephemeral data)
- Hub-managed files (scenarios, parsers from collections)

---

## Philosophy: Configuration as Code

### Core Principles

1. **Explicit over Implicit**
   - Document default values
   - Explain non-obvious choices
   - Reference ADRs for architectural decisions

2. **Templates over Copies**
   - Store templates with placeholders
   - Document substitution variables
   - Include deployment instructions

3. **Validation before Application**
   - Syntax checks before deployment
   - Dry-run capability
   - Rollback plan for every change

4. **Documentation Adjacent to Code**
   - README in template directory
   - Inline comments in configs
   - Link to relevant docs/ADRs

### Anti-Patterns to Avoid

❌ **Don't:**
- Copy production configs directly to Git (may contain secrets)
- Track auto-generated files (creates noise)
- Mix templates with documentation (separate concerns)
- Skip validation (leads to service breakage)

✅ **Do:**
- Sanitize configs before committing (remove secrets)
- Document why configurations exist
- Test templates before declaring them "production ready"
- Version control deployment scripts alongside templates

---

## Phase 4.1: Configuration Inventory

### Objective
Document all CrowdSec configuration files and classify by management strategy.

### Duration
~10 minutes

### Procedure

#### Step 4.1.1: Create Inventory

```bash
echo "=== CrowdSec Configuration Inventory ==="

# Create inventory directory
mkdir -p ~/crowdsec-phase4-inventory

# Inventory all configs
cat > ~/crowdsec-phase4-inventory/config-inventory.md <<'EOF'
# CrowdSec Configuration Inventory

**Date:** $(date)
**CrowdSec Version:** $(podman exec crowdsec cscli version | grep version: | awk '{print $2}')

## Configuration Files

### 1. profiles.yaml
**Location:** ~/containers/data/crowdsec/config/profiles.yaml
**Purpose:** Defines ban duration profiles for different threat severities
**Management Strategy:** Template in Git
**Current State:** Manually created (Phase 1 report)
**Contains Secrets:** No
**Priority:** HIGH

### 2. local-whitelist.yaml
**Location:** ~/containers/data/crowdsec/config/parsers/s02-enrich/local-whitelist.yaml
**Purpose:** Whitelists local network ranges to prevent self-banning
**Management Strategy:** Template in Git
**Current State:** Manually created (Phase 1 report)
**Contains Secrets:** No
**Priority:** HIGH

### 3. config.yaml
**Location:** ~/containers/data/crowdsec/config/config.yaml
**Purpose:** Main CrowdSec configuration (LAPI, paths, etc.)
**Management Strategy:** Do NOT track (auto-generated)
**Current State:** Auto-generated by container
**Contains Secrets:** Potentially (LAPI keys)
**Priority:** DOCUMENT ONLY

### 4. online_api_credentials.yaml
**Location:** ~/containers/data/crowdsec/config/online_api_credentials.yaml
**Purpose:** CAPI authentication credentials
**Management Strategy:** Do NOT track (secrets)
**Current State:** Generated during CAPI enrollment
**Contains Secrets:** YES (CAPI password)
**Priority:** BACKUP ONLY (encrypted)

### 5. local_api_credentials.yaml
**Location:** ~/containers/data/crowdsec/config/local_api_credentials.yaml
**Purpose:** LAPI authentication for bouncers
**Management Strategy:** Do NOT track (secrets)
**Current State:** Auto-generated
**Contains Secrets:** YES (LAPI keys)
**Priority:** BACKUP ONLY (encrypted)

### 6. acquis.yaml (if exists)
**Location:** ~/containers/data/crowdsec/config/acquis.yaml
**Purpose:** Defines log sources for CrowdSec to parse
**Management Strategy:** Template in Git (if customized)
**Current State:** Default (Traefik logs via Docker API)
**Contains Secrets:** No
**Priority:** MEDIUM

## Hub-Managed Files (Do NOT Track)

These are managed by `cscli hub` and should not be version controlled:
- `/etc/crowdsec/scenarios/**` - Installed via collections
- `/etc/crowdsec/parsers/**` (except custom ones in s02-enrich)
- `/etc/crowdsec/postoverflows/**`

## Decision: What to Track

**Track in Git:**
1. profiles.yaml (as template)
2. local-whitelist.yaml (as template)
3. acquis.yaml (if customized)
4. Custom parsers/scenarios (if created)

**Do NOT Track:**
1. config.yaml (auto-generated)
2. *_credentials.yaml (secrets)
3. Database files
4. Hub-managed content
EOF

# Display inventory
cat ~/crowdsec-phase4-inventory/config-inventory.md
```

#### Step 4.1.2: Export Current Configurations

```bash
echo "=== Exporting Current Configurations ==="

# Create export directory
mkdir -p ~/crowdsec-phase4-inventory/current-configs

# Export profiles.yaml
if [ -f ~/containers/data/crowdsec/config/profiles.yaml ]; then
    cp ~/containers/data/crowdsec/config/profiles.yaml \
       ~/crowdsec-phase4-inventory/current-configs/profiles.yaml
    echo "✓ Exported profiles.yaml"
else
    echo "⚠️  profiles.yaml not found (using CrowdSec defaults)"
fi

# Export whitelist
if [ -f ~/containers/data/crowdsec/config/parsers/s02-enrich/local-whitelist.yaml ]; then
    cp ~/containers/data/crowdsec/config/parsers/s02-enrich/local-whitelist.yaml \
       ~/crowdsec-phase4-inventory/current-configs/local-whitelist.yaml
    echo "✓ Exported local-whitelist.yaml"
else
    echo "⚠️  local-whitelist.yaml not found"
fi

# Export acquis.yaml if it exists
if [ -f ~/containers/data/crowdsec/config/acquis.yaml ]; then
    cp ~/containers/data/crowdsec/config/acquis.yaml \
       ~/crowdsec-phase4-inventory/current-configs/acquis.yaml
    echo "✓ Exported acquis.yaml"
else
    echo "ℹ  acquis.yaml not found (using defaults)"
fi

echo ""
echo "Exported configs to: ~/crowdsec-phase4-inventory/current-configs/"
ls -lh ~/crowdsec-phase4-inventory/current-configs/
```

#### Step 4.1.3: Document Configuration Rationale

```bash
echo "=== Documenting Configuration Rationale ==="

cat > ~/crowdsec-phase4-inventory/configuration-decisions.md <<'EOF'
# CrowdSec Configuration Decisions

## profiles.yaml - Tiered Ban Durations

**Decision:** Implement 3-tier ban profile system

**Rationale:**
- **Severe threats (7 days):** CVE exploits, backdoor attempts deserve long bans
- **Aggressive threats (24 hours):** Reconnaissance/scanning needs firm deterrent
- **Standard threats (4 hours):** Proportional response to low-severity issues

**References:**
- ADR: See `docs/99-reports/2025-11-12-crowdsec-security-enhancements.md`
- Design principle: Fail-fast, defense in depth

**Trade-offs:**
- ✅ More sophisticated than single duration
- ✅ Reduces repeat offenders
- ⚠️  More complex to tune
- ⚠️  May need adjustment based on real-world data

---

## local-whitelist.yaml - Network Whitelisting

**Decision:** Whitelist local networks and container networks

**Rationale:**
- Prevents accidentally banning yourself
- Prevents banning internal services
- Focuses CrowdSec on external threats

**Networks Whitelisted:**
- `192.168.1.0/24` - Local LAN
- `192.168.100.0/24` - WireGuard VPN
- `10.89.0.0/16` - All Podman container networks
- `127.0.0.1/8` - Localhost

**References:**
- Design principle: Operations first (don't lock yourself out)
- Related: ADR-001 (Rootless containers)

**Trade-offs:**
- ✅ Prevents operational disasters
- ✅ No false positives for internal traffic
- ⚠️  Trusted networks must be kept updated
- ⚠️  Does not protect against insider threats (acceptable for homelab)

EOF

cat ~/crowdsec-phase4-inventory/configuration-decisions.md
```

### Success Criteria for Phase 4.1

- [ ] Complete configuration inventory created
- [ ] Current configurations exported
- [ ] Configuration rationale documented
- [ ] Files categorized by management strategy

---

## Phase 4.2: Git Integration Strategy

### Objective
Establish directory structure and workflow for managing configs in Git.

### Duration
~10 minutes

### Procedure

#### Step 4.2.1: Create Configuration Directory Structure

```bash
echo "=== Creating Git Directory Structure ==="

cd ~/containers  # Your Git repo root

# Create directory structure
mkdir -p config/crowdsec/templates
mkdir -p config/crowdsec/examples
mkdir -p scripts/crowdsec

echo "✓ Directory structure created"
tree config/crowdsec scripts/crowdsec
```

#### Step 4.2.2: Define Configuration Workflow

```bash
echo "=== Defining Configuration Workflow ==="

cat > config/crowdsec/README.md <<'EOF'
# CrowdSec Configuration Management

This directory contains configuration templates and deployment tools for CrowdSec.

## Directory Structure

```
config/crowdsec/
├── templates/           # Production-ready templates
│   ├── profiles.yaml.template
│   ├── local-whitelist.yaml.template
│   └── acquis.yaml.template
├── examples/            # Example configurations for learning
│   ├── profiles-strict.yaml.example
│   └── profiles-lenient.yaml.example
└── README.md           # This file
```

## Configuration Workflow

### Making Configuration Changes

1. **Edit Template**
   ```bash
   cd ~/containers
   nano config/crowdsec/templates/profiles.yaml.template
   ```

2. **Validate Syntax**
   ```bash
   ./scripts/crowdsec/validate-config.sh profiles.yaml.template
   ```

3. **Deploy to Production**
   ```bash
   ./scripts/crowdsec/deploy-config.sh profiles.yaml.template
   ```

4. **Test in Production**
   ```bash
   # Verify CrowdSec accepted the config
   systemctl --user status crowdsec.service
   podman logs --since 2m crowdsec
   ```

5. **Commit to Git**
   ```bash
   git add config/crowdsec/templates/profiles.yaml.template
   git commit -m "CrowdSec: Update ban profiles - <reason>"
   git push
   ```

### Restoring from Backup

```bash
# List available backups
ls -lt ~/containers/backups/crowdsec/

# Restore specific config
./scripts/crowdsec/restore-config.sh profiles.yaml 2025-11-12
```

### Adding New Configurations

1. Create template in `templates/` directory
2. Add substitution variables (if needed)
3. Document in this README
4. Create deployment procedure in `scripts/crowdsec/`
5. Test deployment in non-production environment
6. Commit with clear commit message

## Template Variables

Some templates use substitution variables:

- `{{LOCAL_NETWORK}}` - Your local network CIDR (e.g., 192.168.1.0/24)
- `{{VPN_NETWORK}}` - Your VPN network CIDR (e.g., 192.168.100.0/24)
- `{{CONTAINER_NETWORK}}` - Podman container networks (e.g., 10.89.0.0/16)

These are substituted during deployment by `deploy-config.sh`.

## Important Notes

### What is Tracked in Git

✅ **Track:**
- Configuration templates (`.template` files)
- Example configurations (`.example` files)
- Deployment scripts
- Documentation

❌ **Do NOT Track:**
- Actual production configs (may contain secrets or local paths)
- Credential files (`*_credentials.yaml`)
- Database files (`*.db`)
- Hub-managed files (scenarios, parsers from collections)

### Secrets Management

Configuration files should NEVER contain secrets. Use:
- Environment variables for Traefik middleware
- Podman secrets for API keys
- File-based secrets with restrictive permissions (600)

### Configuration Validation

Always validate configurations before deployment:
```bash
# Syntax check
./scripts/crowdsec/validate-config.sh <template>

# Dry-run deployment
./scripts/crowdsec/deploy-config.sh --dry-run <template>
```

## Troubleshooting

### Config Not Applied

1. Check CrowdSec logs: `podman logs crowdsec | grep -i error`
2. Verify file permissions: `ls -l ~/containers/data/crowdsec/config/`
3. Restart CrowdSec: `systemctl --user restart crowdsec.service`
4. Validate syntax: `./scripts/crowdsec/validate-config.sh <config>`

### Config Syntax Errors

CrowdSec uses YAML. Common issues:
- Incorrect indentation (use spaces, not tabs)
- Missing colons after keys
- Unquoted special characters
- Invalid YAML structure

Validate with: `yamllint <config-file>`

### Deployment Script Fails

Check:
- Script has execute permissions: `chmod +x scripts/crowdsec/*.sh`
- Running from repository root: `cd ~/containers`
- All dependencies installed (yq, jq, etc.)

## References

- **CrowdSec Docs:** https://docs.crowdsec.net/
- **Phase 1 Manual:** `docs/30-security/guides/crowdsec-phase1-field-manual.md`
- **Phase 4 Plan:** `docs/30-security/guides/crowdsec-phase4-configuration-management.md`
- **Project Config Principles:** `docs/00-foundation/guides/configuration-design-quick-reference.md`
EOF

echo "✓ Workflow documentation created"
```

#### Step 4.2.3: Update .gitignore

```bash
echo "=== Updating .gitignore ==="

cd ~/containers

# Add CrowdSec-specific ignores if not already present
cat >> .gitignore <<'EOF'

# CrowdSec Configuration Management
# Track templates, not production configs
config/crowdsec/production/
*_credentials.yaml
*.db
*.mmdb

# CrowdSec backups (too large for Git)
backups/crowdsec/
EOF

echo "✓ .gitignore updated"
```

### Success Criteria for Phase 4.2

- [ ] Directory structure created
- [ ] Workflow documentation written
- [ ] .gitignore updated
- [ ] Clear separation between templates and production configs

---

## Phase 4.3: Template Creation

### Objective
Create production-ready configuration templates from current configs.

### Duration
~15 minutes

### Procedure

#### Step 4.3.1: Create profiles.yaml Template

```bash
echo "=== Creating profiles.yaml Template ==="

cd ~/containers

cat > config/crowdsec/templates/profiles.yaml.template <<'EOF'
# CrowdSec Ban Profiles - Tiered Duration Strategy
#
# This configuration implements a 3-tier ban system based on threat severity.
# See: docs/99-reports/2025-11-12-crowdsec-security-enhancements.md
#
# Template Variables:
#   (none - this template uses static values)
#
# Deployment:
#   cp config/crowdsec/templates/profiles.yaml.template ~/containers/data/crowdsec/config/profiles.yaml
#   systemctl --user restart crowdsec.service

name: default_ip_remediation
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
decisions:
  - type: ban
    duration: 4h
on_success: break

---

# ═══════════════════════════════════════════════════════════
# TIER 1: SEVERE THREATS (7-day ban)
# ═══════════════════════════════════════════════════════════
# Attacks that demonstrate:
# - Exploitation attempts (CVEs)
# - Brute force persistence
# - Known malicious patterns
# - Backdoor installation attempts

name: severe_threats
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
  - |
      any(Alert.GetScenarios(), {
        # CVE Exploits
        str.Contains(#, "CVE-") ||
        str.Contains(#, "http-cve") ||

        # Brute Force
        str.Contains(#, "-bf") ||
        str.Contains(#, "brute") ||

        # Backdoor/Shell Attempts
        str.Contains(#, "backdoor") ||
        str.Contains(#, "webshell") ||

        # Known Malicious Behavior
        str.Contains(#, "exploit")
      })
decisions:
  - type: ban
    duration: 168h  # 7 days
on_success: break

---

# ═══════════════════════════════════════════════════════════
# TIER 2: AGGRESSIVE THREATS (24-hour ban)
# ═══════════════════════════════════════════════════════════
# Reconnaissance and attack preparation:
# - Port scanning
# - Directory enumeration
# - Sensitive file access
# - Admin interface probing

name: aggressive_threats
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
  - |
      any(Alert.GetScenarios(), {
        # Probing/Scanning
        str.Contains(#, "probing") ||
        str.Contains(#, "scan") ||

        # Enumeration
        str.Contains(#, "crawl") ||
        str.Contains(#, "enum") ||

        # Sensitive Access
        str.Contains(#, "sensitive") ||
        str.Contains(#, "admin-interface") ||

        # Path Traversal
        str.Contains(#, "path-traversal") ||
        str.Contains(#, "lfi")
      })
decisions:
  - type: ban
    duration: 24h
on_success: break

---

# ═══════════════════════════════════════════════════════════
# TIER 3: STANDARD THREATS (4-hour ban)
# ═══════════════════════════════════════════════════════════
# Default catch-all for other detected threats:
# - Bad user agents
# - Generic suspicious behavior
# - Low-severity violations

name: standard_threats
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
decisions:
  - type: ban
    duration: 4h
on_success: break

---

# ═══════════════════════════════════════════════════════════
# IP RANGE BANS (Cautious Duration)
# ═══════════════════════════════════════════════════════════
# Range bans are more cautious - may affect legitimate users in same range

name: range_remediation
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Range"
decisions:
  - type: ban
    duration: 4h
on_success: break
EOF

echo "✓ profiles.yaml template created"
```

#### Step 4.3.2: Create local-whitelist.yaml Template

```bash
echo "=== Creating local-whitelist.yaml Template ==="

cat > config/crowdsec/templates/local-whitelist.yaml.template <<'EOF'
# CrowdSec Local Network Whitelist
#
# Purpose: Prevents CrowdSec from banning trusted local networks
# Location: parsers/s02-enrich/local-whitelist.yaml
#
# Template Variables:
#   {{LOCAL_NETWORK}} - Your local LAN CIDR (default: 192.168.1.0/24)
#   {{VPN_NETWORK}} - Your VPN CIDR (default: 192.168.100.0/24)
#   {{CONTAINER_NETWORK}} - Podman container network (default: 10.89.0.0/16)
#
# Deployment:
#   1. Edit variables in scripts/crowdsec/deploy-config.sh
#   2. Run: ./scripts/crowdsec/deploy-config.sh local-whitelist.yaml.template
#   3. Restart: systemctl --user restart crowdsec.service

name: patriark/my-whitelist
description: "Whitelist for local and trusted networks"
whitelist:
  reason: "Local LAN - trusted network"
  ip:
    - "{{LOCAL_NETWORK}}"           # Local network
  expression:
    # Empty for now

---

name: patriark/vpn-whitelist
description: "Whitelist for VPN connections"
whitelist:
  reason: "WireGuard VPN - trusted remote access"
  ip:
    - "{{VPN_NETWORK}}"             # VPN network
  expression:
    # Empty for now

---

name: patriark/container-whitelist
description: "Whitelist for Podman container networks"
whitelist:
  reason: "Internal container communication"
  ip:
    - "{{CONTAINER_NETWORK}}"       # All podman networks
    - "127.0.0.1"                   # Localhost IPv4
    - "::1"                         # Localhost IPv6
  expression:
    # Empty for now
EOF

echo "✓ local-whitelist.yaml template created"
```

#### Step 4.3.3: Create Example Configurations

```bash
echo "=== Creating Example Configurations ==="

# Example 1: Strict profiles (shorter bans)
cat > config/crowdsec/examples/profiles-strict.yaml.example <<'EOF'
# EXAMPLE: Strict Ban Profiles (Shorter Durations)
#
# Use case: High-traffic public site that needs to be more forgiving
# Trade-off: Less protection, but fewer false positive impacts
#
# This is an EXAMPLE only - not for production use without testing

name: severe_threats_strict
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
  - any(Alert.GetScenarios(), { str.Contains(#, "CVE-") })
decisions:
  - type: ban
    duration: 48h  # 2 days instead of 7

---

name: aggressive_threats_strict
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
  - any(Alert.GetScenarios(), { str.Contains(#, "probing") })
decisions:
  - type: ban
    duration: 8h  # 8 hours instead of 24

---

name: standard_threats_strict
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
decisions:
  - type: ban
    duration: 2h  # 2 hours instead of 4
EOF

# Example 2: Lenient profiles (longer bans)
cat > config/crowdsec/examples/profiles-lenient.yaml.example <<'EOF'
# EXAMPLE: Lenient Ban Profiles (Longer Durations)
#
# Use case: Private homelab with zero tolerance for threats
# Trade-off: Maximum protection, but may impact false positives harder
#
# This is an EXAMPLE only - not for production use without testing

name: severe_threats_lenient
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
  - any(Alert.GetScenarios(), { str.Contains(#, "CVE-") })
decisions:
  - type: ban
    duration: 720h  # 30 days

---

name: aggressive_threats_lenient
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
  - any(Alert.GetScenarios(), { str.Contains(#, "probing") })
decisions:
  - type: ban
    duration: 168h  # 7 days

---

name: standard_threats_lenient
filters:
  - Alert.Remediation == true && Alert.GetScope() == "Ip"
decisions:
  - type: ban
    duration: 24h  # 24 hours
EOF

echo "✓ Example configurations created"
```

### Success Criteria for Phase 4.3

- [ ] profiles.yaml template created
- [ ] local-whitelist.yaml template created
- [ ] Example configurations provided
- [ ] Templates documented with comments

---

## Phase 4.4: Validation Framework

### Objective
Create scripts to validate configuration syntax before deployment.

### Duration
~10 minutes

### Procedure

#### Step 4.4.1: Create Validation Script

```bash
echo "=== Creating Validation Script ==="

cd ~/containers

cat > scripts/crowdsec/validate-config.sh <<'EOF'
#!/bin/bash
# CrowdSec Configuration Validation Script
#
# Usage: ./validate-config.sh <template-file>
# Example: ./validate-config.sh config/crowdsec/templates/profiles.yaml.template

set -e

TEMPLATE_FILE="$1"

if [ -z "$TEMPLATE_FILE" ]; then
    echo "Usage: $0 <template-file>"
    exit 1
fi

if [ ! -f "$TEMPLATE_FILE" ]; then
    echo "Error: Template file not found: $TEMPLATE_FILE"
    exit 1
fi

echo "=== Validating CrowdSec Configuration ==="
echo "Template: $TEMPLATE_FILE"
echo ""

# Check 1: YAML syntax validation
echo "[1/3] Checking YAML syntax..."
if command -v yamllint &> /dev/null; then
    yamllint -d relaxed "$TEMPLATE_FILE"
    echo "  ✓ YAML syntax valid"
else
    echo "  ⚠️  yamllint not installed, skipping YAML validation"
    echo "  Install with: pip install yamllint"
fi

# Check 2: Check for common mistakes
echo "[2/3] Checking for common mistakes..."

# Check for tabs (YAML should use spaces)
if grep -q $'\t' "$TEMPLATE_FILE"; then
    echo "  ✗ ERROR: File contains tabs (use spaces for YAML)"
    exit 1
else
    echo "  ✓ No tabs found"
fi

# Check for unsubstituted variables (if not a .template file being deployed)
if [[ "$TEMPLATE_FILE" != *.template ]]; then
    if grep -q '{{.*}}' "$TEMPLATE_FILE"; then
        echo "  ⚠️  WARNING: File contains template variables ({{VAR}})"
        echo "     This is OK for .template files, but production configs should have these substituted"
    fi
fi

echo "  ✓ Common mistake checks passed"

# Check 3: CrowdSec-specific validation
echo "[3/3] CrowdSec-specific validation..."

# Profiles should have required keys
if [[ "$TEMPLATE_FILE" == *profiles* ]]; then
    if ! grep -q "^name:" "$TEMPLATE_FILE"; then
        echo "  ✗ ERROR: profiles.yaml missing 'name' field"
        exit 1
    fi
    if ! grep -q "^decisions:" "$TEMPLATE_FILE"; then
        echo "  ✗ ERROR: profiles.yaml missing 'decisions' field"
        exit 1
    fi
    echo "  ✓ Profile structure valid"
fi

# Whitelist should have required keys
if [[ "$TEMPLATE_FILE" == *whitelist* ]]; then
    if ! grep -q "^whitelist:" "$TEMPLATE_FILE"; then
        echo "  ✗ ERROR: whitelist file missing 'whitelist' field"
        exit 1
    fi
    echo "  ✓ Whitelist structure valid"
fi

echo ""
echo "✅ Validation passed: $TEMPLATE_FILE"
echo "Ready for deployment"
EOF

chmod +x scripts/crowdsec/validate-config.sh

echo "✓ Validation script created"
```

#### Step 4.4.2: Create Deployment Script

```bash
echo "=== Creating Deployment Script ==="

cat > scripts/crowdsec/deploy-config.sh <<'EOF'
#!/bin/bash
# CrowdSec Configuration Deployment Script
#
# Usage: ./deploy-config.sh [--dry-run] <template-file>
# Example: ./deploy-config.sh config/crowdsec/templates/profiles.yaml.template

set -e

# Parse arguments
DRY_RUN=false
if [ "$1" = "--dry-run" ]; then
    DRY_RUN=true
    shift
fi

TEMPLATE_FILE="$1"

if [ -z "$TEMPLATE_FILE" ]; then
    echo "Usage: $0 [--dry-run] <template-file>"
    exit 1
fi

if [ ! -f "$TEMPLATE_FILE" ]; then
    echo "Error: Template file not found: $TEMPLATE_FILE"
    exit 1
fi

# Configuration variables (customize for your environment)
LOCAL_NETWORK="192.168.1.0/24"
VPN_NETWORK="192.168.100.0/24"
CONTAINER_NETWORK="10.89.0.0/16"

echo "=== CrowdSec Configuration Deployment ==="
echo "Template: $TEMPLATE_FILE"
echo "Dry Run: $DRY_RUN"
echo ""

# Step 1: Validate template
echo "[1/4] Validating template..."
./scripts/crowdsec/validate-config.sh "$TEMPLATE_FILE"

# Step 2: Substitute variables
echo "[2/4] Substituting variables..."
TEMP_FILE=$(mktemp)
sed -e "s|{{LOCAL_NETWORK}}|$LOCAL_NETWORK|g" \
    -e "s|{{VPN_NETWORK}}|$VPN_NETWORK|g" \
    -e "s|{{CONTAINER_NETWORK}}|$CONTAINER_NETWORK|g" \
    "$TEMPLATE_FILE" > "$TEMP_FILE"

echo "  ✓ Variables substituted"

# Step 3: Determine destination
FILENAME=$(basename "$TEMPLATE_FILE" .template)

if [[ "$FILENAME" == *profiles* ]]; then
    DEST="$HOME/containers/data/crowdsec/config/profiles.yaml"
elif [[ "$FILENAME" == *whitelist* ]]; then
    DEST="$HOME/containers/data/crowdsec/config/parsers/s02-enrich/local-whitelist.yaml"
    mkdir -p "$(dirname "$DEST")"
elif [[ "$FILENAME" == *acquis* ]]; then
    DEST="$HOME/containers/data/crowdsec/config/acquis.yaml"
else
    echo "Error: Unknown config type: $FILENAME"
    rm "$TEMP_FILE"
    exit 1
fi

echo "[3/4] Destination: $DEST"

# Step 4: Deploy (or dry-run)
if [ "$DRY_RUN" = true ]; then
    echo "[4/4] DRY RUN - Would deploy to: $DEST"
    echo ""
    echo "Rendered configuration:"
    cat "$TEMP_FILE"
    echo ""
    echo "✓ Dry run complete (no changes made)"
else
    echo "[4/4] Deploying configuration..."

    # Backup existing config
    if [ -f "$DEST" ]; then
        BACKUP="$DEST.backup-$(date +%Y%m%d-%H%M%S)"
        cp "$DEST" "$BACKUP"
        echo "  ✓ Backed up existing config to: $BACKUP"
    fi

    # Deploy new config
    cp "$TEMP_FILE" "$DEST"
    chmod 644 "$DEST"
    echo "  ✓ Configuration deployed"

    # Restart CrowdSec
    echo ""
    echo "Restarting CrowdSec to apply changes..."
    systemctl --user restart crowdsec.service

    sleep 5

    # Verify service is healthy
    if systemctl --user is-active crowdsec.service > /dev/null; then
        echo "  ✓ CrowdSec restarted successfully"
    else
        echo "  ✗ ERROR: CrowdSec failed to start"
        echo "  Rolling back..."
        if [ -f "$BACKUP" ]; then
            cp "$BACKUP" "$DEST"
            systemctl --user restart crowdsec.service
            echo "  ✓ Rolled back to previous configuration"
        fi
        rm "$TEMP_FILE"
        exit 1
    fi

    echo ""
    echo "✅ Deployment complete!"
    echo "Configuration deployed to: $DEST"
fi

# Cleanup
rm "$TEMP_FILE"
EOF

chmod +x scripts/crowdsec/deploy-config.sh

echo "✓ Deployment script created"
```

### Success Criteria for Phase 4.4

- [ ] Validation script created and executable
- [ ] Deployment script created and executable
- [ ] Scripts tested with dry-run mode
- [ ] Rollback capability included

---

## Phase 4.5: Backup and Restore Procedures

### Objective
Automate backup of CrowdSec configurations and create restore procedures.

### Duration
~10 minutes

### Procedure

#### Step 4.5.1: Create Backup Script

```bash
echo "=== Creating Backup Script ==="

cd ~/containers

cat > scripts/crowdsec/backup-config.sh <<'EOF'
#!/bin/bash
# CrowdSec Configuration Backup Script
#
# Usage: ./backup-config.sh [backup-name]
# Example: ./backup-config.sh "before-phase3"

BACKUP_NAME="${1:-$(date +%Y%m%d-%H%M%S)}"
BACKUP_DIR="$HOME/containers/backups/crowdsec/$BACKUP_NAME"

echo "=== CrowdSec Configuration Backup ==="
echo "Backup name: $BACKUP_NAME"
echo "Destination: $BACKUP_DIR"
echo ""

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Backup critical configs
echo "Backing up configurations..."

# 1. profiles.yaml
if [ -f "$HOME/containers/data/crowdsec/config/profiles.yaml" ]; then
    cp "$HOME/containers/data/crowdsec/config/profiles.yaml" "$BACKUP_DIR/"
    echo "  ✓ profiles.yaml"
fi

# 2. local-whitelist.yaml
if [ -f "$HOME/containers/data/crowdsec/config/parsers/s02-enrich/local-whitelist.yaml" ]; then
    mkdir -p "$BACKUP_DIR/parsers/s02-enrich"
    cp "$HOME/containers/data/crowdsec/config/parsers/s02-enrich/local-whitelist.yaml" \
       "$BACKUP_DIR/parsers/s02-enrich/"
    echo "  ✓ local-whitelist.yaml"
fi

# 3. acquis.yaml (if exists)
if [ -f "$HOME/containers/data/crowdsec/config/acquis.yaml" ]; then
    cp "$HOME/containers/data/crowdsec/config/acquis.yaml" "$BACKUP_DIR/"
    echo "  ✓ acquis.yaml"
fi

# 4. Custom scenarios/parsers (if any)
if [ -d "$HOME/containers/data/crowdsec/config/scenarios/local" ]; then
    cp -r "$HOME/containers/data/crowdsec/config/scenarios/local" "$BACKUP_DIR/scenarios/"
    echo "  ✓ Custom scenarios"
fi

# 5. Metadata
cat > "$BACKUP_DIR/backup-metadata.txt" <<METADATA
Backup Name: $BACKUP_NAME
Date: $(date)
CrowdSec Version: $(podman exec crowdsec cscli version 2>/dev/null | grep version: | awk '{print $2}' || echo "unknown")
Scenario Count: $(podman exec crowdsec cscli scenarios list 2>/dev/null | grep -c enabled || echo "unknown")
Decision Count: $(podman exec crowdsec cscli decisions list 2>/dev/null | wc -l || echo "unknown")
METADATA

echo "  ✓ Metadata"

# 6. Export current state
podman exec crowdsec cscli scenarios list > "$BACKUP_DIR/scenarios-list.txt" 2>/dev/null || true
podman exec crowdsec cscli collections list > "$BACKUP_DIR/collections-list.txt" 2>/dev/null || true

echo ""
echo "✅ Backup complete: $BACKUP_DIR"
ls -lh "$BACKUP_DIR"
EOF

chmod +x scripts/crowdsec/backup-config.sh

echo "✓ Backup script created"
```

#### Step 4.5.2: Create Restore Script

```bash
echo "=== Creating Restore Script ==="

cat > scripts/crowdsec/restore-config.sh <<'EOF'
#!/bin/bash
# CrowdSec Configuration Restore Script
#
# Usage: ./restore-config.sh <backup-name> [config-file]
# Examples:
#   ./restore-config.sh 2025-11-12-143000           # Restore all configs
#   ./restore-config.sh 2025-11-12-143000 profiles.yaml  # Restore specific file

set -e

BACKUP_NAME="$1"
SPECIFIC_FILE="$2"

if [ -z "$BACKUP_NAME" ]; then
    echo "Usage: $0 <backup-name> [config-file]"
    echo ""
    echo "Available backups:"
    ls -1 "$HOME/containers/backups/crowdsec/" 2>/dev/null || echo "  (no backups found)"
    exit 1
fi

BACKUP_DIR="$HOME/containers/backups/crowdsec/$BACKUP_NAME"

if [ ! -d "$BACKUP_DIR" ]; then
    echo "Error: Backup not found: $BACKUP_DIR"
    exit 1
fi

echo "=== CrowdSec Configuration Restore ==="
echo "Backup: $BACKUP_NAME"
echo "Source: $BACKUP_DIR"
echo ""

# Show backup metadata
if [ -f "$BACKUP_DIR/backup-metadata.txt" ]; then
    echo "Backup information:"
    cat "$BACKUP_DIR/backup-metadata.txt"
    echo ""
fi

# Confirm restore
echo "⚠️  WARNING: This will overwrite current configurations!"
echo "Press ENTER to continue, or Ctrl+C to abort..."
read

# Restore function
restore_file() {
    local src="$1"
    local dest="$2"

    if [ -f "$src" ]; then
        # Backup current file first
        if [ -f "$dest" ]; then
            cp "$dest" "$dest.pre-restore-$(date +%Y%m%d-%H%M%S)"
        fi

        # Restore from backup
        mkdir -p "$(dirname "$dest")"
        cp "$src" "$dest"
        echo "  ✓ Restored: $(basename "$dest")"
    else
        echo "  ⚠️  Not in backup: $(basename "$dest")"
    fi
}

# Restore specific file or all files
if [ -n "$SPECIFIC_FILE" ]; then
    echo "Restoring specific file: $SPECIFIC_FILE"

    case "$SPECIFIC_FILE" in
        profiles.yaml)
            restore_file "$BACKUP_DIR/profiles.yaml" \
                        "$HOME/containers/data/crowdsec/config/profiles.yaml"
            ;;
        local-whitelist.yaml)
            restore_file "$BACKUP_DIR/parsers/s02-enrich/local-whitelist.yaml" \
                        "$HOME/containers/data/crowdsec/config/parsers/s02-enrich/local-whitelist.yaml"
            ;;
        acquis.yaml)
            restore_file "$BACKUP_DIR/acquis.yaml" \
                        "$HOME/containers/data/crowdsec/config/acquis.yaml"
            ;;
        *)
            echo "Error: Unknown config file: $SPECIFIC_FILE"
            exit 1
            ;;
    esac
else
    echo "Restoring all configurations..."

    restore_file "$BACKUP_DIR/profiles.yaml" \
                "$HOME/containers/data/crowdsec/config/profiles.yaml"

    restore_file "$BACKUP_DIR/parsers/s02-enrich/local-whitelist.yaml" \
                "$HOME/containers/data/crowdsec/config/parsers/s02-enrich/local-whitelist.yaml"

    restore_file "$BACKUP_DIR/acquis.yaml" \
                "$HOME/containers/data/crowdsec/config/acquis.yaml"
fi

# Restart CrowdSec
echo ""
echo "Restarting CrowdSec..."
systemctl --user restart crowdsec.service

sleep 5

# Verify
if systemctl --user is-active crowdsec.service > /dev/null; then
    echo "  ✓ CrowdSec restarted successfully"
else
    echo "  ✗ ERROR: CrowdSec failed to start after restore"
    echo "  Check logs: podman logs crowdsec"
    exit 1
fi

echo ""
echo "✅ Restore complete!"
EOF

chmod +x scripts/crowdsec/restore-config.sh

echo "✓ Restore script created"
```

#### Step 4.5.3: Test Backup and Restore

```bash
echo "=== Testing Backup and Restore ==="

# Create a test backup
echo "Creating test backup..."
./scripts/crowdsec/backup-config.sh "phase4-test-backup"

# Verify backup was created
if [ -d "$HOME/containers/backups/crowdsec/phase4-test-backup" ]; then
    echo "✓ Test backup created successfully"
    ls -lh "$HOME/containers/backups/crowdsec/phase4-test-backup"
else
    echo "✗ Test backup failed"
    exit 1
fi

echo ""
echo "✓ Backup/restore scripts tested"
echo "Note: Actual restore testing should be done in controlled environment"
```

### Success Criteria for Phase 4.5

- [ ] Backup script created and tested
- [ ] Restore script created
- [ ] Scripts handle missing files gracefully
- [ ] Metadata captured in backups

---

## Phase 4.6: Documentation Standards

### Objective
Establish documentation standards for configuration changes.

### Duration
~5 minutes

### Procedure

#### Step 4.6.1: Create Configuration Change Template

```bash
echo "=== Creating Configuration Change Template ==="

cd ~/containers

cat > config/crowdsec/CONFIGURATION-CHANGE-TEMPLATE.md <<'EOF'
# CrowdSec Configuration Change: [Brief Description]

**Date:** YYYY-MM-DD
**Author:** [Your Name]
**Change Type:** [New Configuration / Modification / Rollback]
**Risk Level:** [Low / Medium / High]

---

## Summary

[One paragraph explaining what changed and why]

---

## Changes Made

### Files Modified

- `profiles.yaml` - [What changed]
- `local-whitelist.yaml` - [What changed]

### Specific Changes

```yaml
# Before:
[old configuration snippet]

# After:
[new configuration snippet]
```

---

## Rationale

### Problem Statement

[What problem does this change solve?]

### Solution Approach

[Why was this approach chosen?]

### Alternatives Considered

1. **Option A:** [Description] - Rejected because [reason]
2. **Option B:** [Description] - Rejected because [reason]

---

## Testing

### Pre-Deployment Testing

- [ ] Syntax validation passed
- [ ] Dry-run deployment successful
- [ ] Reviewed by: [Name]

### Post-Deployment Verification

- [ ] CrowdSec restarted successfully
- [ ] No errors in logs
- [ ] Metrics look normal
- [ ] Test cases passed:
  - [ ] [Test case 1]
  - [ ] [Test case 2]

---

## Impact Assessment

### Expected Impact

- **Security:** [How does this affect security posture?]
- **Performance:** [Any performance implications?]
- **Operations:** [Does this change operational procedures?]

### Actual Impact (Post-Deployment)

[To be filled in after 24-48 hours of operation]

---

## Rollback Plan

### Rollback Procedure

```bash
# If this change needs to be reverted:
./scripts/crowdsec/restore-config.sh [backup-name]
```

### Rollback Triggers

Revert this change if:
- [ ] False positive rate >5%
- [ ] Service instability
- [ ] [Other trigger]

---

## References

- **ADR:** [Link to Architecture Decision Record, if applicable]
- **Related Issue:** [Link to GitHub issue]
- **Documentation:** [Link to relevant docs]
- **Discussion:** [Link to discussion thread]

---

## Approval

- [x] Self-review completed
- [ ] Peer review (if applicable): [Name]
- [x] Ready for deployment

---

**Deployment Command:**
```bash
./scripts/crowdsec/deploy-config.sh config/crowdsec/templates/[filename]
```
EOF

echo "✓ Configuration change template created"
```

#### Step 4.6.2: Update Main README

```bash
echo "=== Updating Main README ==="

# Add Phase 4 section to main CrowdSec README
cat >> config/crowdsec/README.md <<'EOF'

## Configuration Change Process

All configuration changes should follow this workflow:

1. **Document the change** using `CONFIGURATION-CHANGE-TEMPLATE.md`
2. **Create/update template** in `templates/` directory
3. **Validate syntax** with `./scripts/crowdsec/validate-config.sh`
4. **Backup current state** with `./scripts/crowdsec/backup-config.sh`
5. **Dry-run deployment** with `./scripts/crowdsec/deploy-config.sh --dry-run`
6. **Deploy to production** with `./scripts/crowdsec/deploy-config.sh`
7. **Verify deployment** (check logs, metrics, service health)
8. **Commit to Git** with descriptive commit message
9. **Monitor for 24-48 hours** and update change document with actual impact

### Configuration Change Documentation

Store change documentation in:
- `docs/99-reports/` for significant changes
- Git commit messages for minor changes

### Git Commit Message Format

```
CrowdSec: [Brief description]

[Longer explanation of what changed and why]

Changes:
- profiles.yaml: [specific change]
- local-whitelist.yaml: [specific change]

Testing: [how it was tested]
Impact: [expected impact]

Refs: #issue-number (if applicable)
```
EOF

echo "✓ README updated with change process"
```

### Success Criteria for Phase 4.6

- [ ] Configuration change template created
- [ ] Documentation standards established
- [ ] Git commit message format defined
- [ ] Change process integrated into README

---

## Operational Procedures

### Daily Operations

**No daily tasks required** - configurations are stable once deployed.

### When Making Configuration Changes

1. **Before starting:**
   ```bash
   # Create backup
   ./scripts/crowdsec/backup-config.sh "before-[change-description]"
   ```

2. **Make the change:**
   ```bash
   # Edit template
   nano config/crowdsec/templates/profiles.yaml.template

   # Validate
   ./scripts/crowdsec/validate-config.sh config/crowdsec/templates/profiles.yaml.template

   # Dry-run
   ./scripts/crowdsec/deploy-config.sh --dry-run config/crowdsec/templates/profiles.yaml.template
   ```

3. **Deploy:**
   ```bash
   # Deploy to production
   ./scripts/crowdsec/deploy-config.sh config/crowdsec/templates/profiles.yaml.template
   ```

4. **Verify:**
   ```bash
   # Check service
   systemctl --user status crowdsec.service

   # Check logs
   podman logs --since 2m crowdsec | grep -i error

   # Check metrics
   podman exec crowdsec cscli metrics
   ```

5. **Commit:**
   ```bash
   git add config/crowdsec/templates/profiles.yaml.template
   git commit -m "CrowdSec: [description of change]"
   git push
   ```

### Troubleshooting Configuration Issues

**Syntax errors:**
```bash
# Validate YAML
./scripts/crowdsec/validate-config.sh [config-file]

# Check for tabs
cat -A [config-file] | grep '\^I'
```

**Deployment failures:**
```bash
# Check CrowdSec logs
podman logs crowdsec | grep -i error

# Restore from backup
./scripts/crowdsec/restore-config.sh [backup-name]
```

**Configuration not taking effect:**
```bash
# Restart CrowdSec
systemctl --user restart crowdsec.service

# Verify file location
ls -l ~/containers/data/crowdsec/config/profiles.yaml

# Check permissions
ls -l ~/containers/data/crowdsec/config/
```

---

## Final Validation Checklist

After completing Phase 4:

- [ ] All critical configs inventoried
- [ ] Templates created and documented
- [ ] Validation scripts tested
- [ ] Deployment scripts tested
- [ ] Backup script tested
- [ ] Restore script created (test in non-prod)
- [ ] Documentation standards established
- [ ] Configuration change process defined
- [ ] All scripts executable and working
- [ ] Everything committed to Git

---

## Next Steps

After successful Phase 4 completion:

**Phase 2:** Observability Integration (if not done yet)
- Expose CrowdSec metrics to Prometheus
- Create Grafana dashboards
- Set up alerting

**Phase 5:** Advanced Hardening
- Custom ban response pages
- Notification integrations (Discord, email)
- Automated threat reports

---

## Document Control

**Version:** 1.0
**Created:** 2025-11-12
**Author:** Claude (AI Assistant)
**Status:** Ready for execution
**Dependencies:** Phase 1 completion

**Related Documents:**
- `crowdsec-phase1-field-manual.md` - Phase 1 procedures
- `crowdsec-phase3-threat-intelligence.md` - Phase 3 plan
- `docs/00-foundation/guides/configuration-design-quick-reference.md` - Config principles

---

**END OF PHASE 4 PLAN**
