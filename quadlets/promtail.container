[Unit]
Description=Promtail - Log Collector for Loki
After=network-online.target monitoring-network.service loki.service
Wants=network-online.target loki.service
Requires=monitoring-network.service

[Container]
Image=docker.io/grafana/promtail:latest
ContainerName=promtail
HostName=promtail
AutoUpdate=registry
Network=systemd-monitoring

# Promtail configuration
Volume=%h/containers/config/promtail:/etc/promtail:ro,Z
Volume=%h/containers/data/promtail:/tmp:Z
Volume=/mnt/btrfs-pool/subvol7-containers/journal-export:/var/log/journal-export:ro,Z

# Remediation decision log (JSONL)
Volume=%h/containers/.claude/context/decision-log.jsonl:/var/log/remediation/decision-log.jsonl:ro,z

# Traefik access logs
Volume=/mnt/btrfs-pool/subvol7-containers/traefik-logs:/var/log/traefik:ro,z

# Promtail command line arguments
Exec=-config.file=/etc/promtail/promtail-config.yml

DNS=192.168.1.69

# Promtail image (Debian-based) has bash but no curl/wget; use /dev/tcp for health check
HealthCmd=bash -c 'exec 3<>/dev/tcp/localhost/9080 && echo -e "GET /ready HTTP/1.0\r\nHost: localhost\r\n\r\n" >&3 && timeout 2 cat <&3 | grep -q Ready'
HealthInterval=30s
HealthRetries=3
HealthStartPeriod=15s
HealthTimeout=5s

[Service]
Slice=container.slice
Restart=on-failure
TimeoutStartSec=60

# Resource Limits
MemoryMax=256M
MemoryHigh=230M

[Install]
WantedBy=default.target
