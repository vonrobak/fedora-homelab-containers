# ~/containers/config/traefik/dynamic/{{SERVICE_NAME}}-router.yml
# Generated by homelab-deployment skill
# API service (with CORS support)

http:
  routers:
    {{SERVICE_NAME}}-secure:
      rule: "Host(`{{HOSTNAME}}`)"
      entryPoints:
        - websecure
      middlewares:
        - crowdsec-bouncer@file      # 1. Block bad IPs
        - rate-limit@file             # 2. Standard rate limiting
        - api-cors@file               # 3. CORS headers
        - authelia@file               # 4. API authentication
        - security-headers@file       # 5. Security headers
      service: {{SERVICE_NAME}}-service
      tls:
        certResolver: letsencrypt

  services:
    {{SERVICE_NAME}}-service:
      loadBalancer:
        servers:
          - url: "http://{{SERVICE_NAME}}:{{PORT}}"
        passHostHeader: true
        healthCheck:
          path: "{{HEALTH_PATH}}"
          interval: "30s"
          timeout: "10s"

  middlewares:
    api-cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowOriginList:
          - "{{CORS_ORIGIN}}"
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
          - "X-Requested-With"
        accessControlMaxAge: 100
        addVaryHeader: true
